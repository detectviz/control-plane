<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=resource-width, initial-scale=1.0">
  <title>Control Plane 維運監控平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>
  <style>
    body {
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
    }

    /* Custom scrollbar for better aesthetics */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
      background: #94a3b8;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    .sidebar-link.active {
      background-color: #1e3a8a;
      /* A darker blue for active state */
      color: white;
      font-weight: 600;
    }

    .prose {
      color: #334155;
    }

    .prose h3 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #1e293b;
    }

    .prose h4 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      color: #1e293b;
    }

    .prose p,
    .prose ul,
    .prose ol {
      margin-bottom: 1rem;
    }

    .prose ul {
      list-style-type: disc;
      padding-left: 1.5rem;
    }

    .prose strong {
      color: #0f172a;
    }

    /* Accordion Menu Styles */
    .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }

    .submenu-toggle.open+.submenu {
      max-height: 500px;
      /* Adjust as needed */
    }

    .chevron-icon {
      transition: transform 0.3s ease-in-out;
    }

    .submenu-toggle.open .chevron-icon {
      transform: rotate(180deg);
    }


    /* Batch Operations Styles */
    .resource-checkbox:checked {
      background-color: #3b82f6;
      border-color: #3b82f6;
    }

    /* Custom styles for better input visibility */
    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      border: 1px solid #94a3b8;
      /* Corresponds to slate-400 */
      padding-top: 0.375rem;
      padding-bottom: 0.375rem;
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }

    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      border-color: #3b82f6;
      /* Corresponds to blue-500 */
      box-shadow: 0 0 0 2px #bfdbfe;
      /* A ring effect like Tailwind's focus rings */
    }

    /* Responsive Table Styles */
    @media (max-width: 768px) {
      .rwd-table thead {
        display: none;
      }

      .rwd-table tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      }

      .rwd-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .rwd-table tr td:last-child {
        border-bottom: none;
      }

      .rwd-table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #475569;
      }
    }
  </style>
</head>

<body class="bg-slate-100">

  <div id="login-page" class="flex items-center justify-center h-screen bg-slate-200">
    <div class="w-full max-w-md">
      <form id="login-form" class="bg-white shadow-lg rounded-xl px-8 pt-6 pb-8 mb-4">
        <div class="mb-8 text-center">
          <img src="LOGO.png" alt="Control Plane Logo" class="inline-block h-12 w-auto mb-2">
          <h1 class="text-2xl font-bold text-slate-800">Control Plane</h1>
        </div>
        <div id="login-error"
          class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
          <strong class="font-bold">錯誤：</strong>
          <span class="block sm:inline">帳號或密碼不正確。</span>
        </div>
        <div class="mb-4">
          <label class="block text-slate-700 text-sm font-bold mb-2" for="username">
            帳號
          </label>
          <input
            class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline"
            id="username" type="text" placeholder="請輸入帳號" value="admin">
        </div>
        <div class="mb-6">
          <label class="block text-slate-700 text-sm font-bold mb-2" for="password">
            密碼
          </label>
          <input
            class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-slate-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
            id="password" type="password" placeholder="******************" value="admin">
        </div>
        <div class="flex items-center justify-between">
          <button
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full"
            type="submit">
            登入
          </button>
        </div>
        <div class="mt-6 text-xs text-slate-500 text-center">
          <p><strong>測試帳號：</strong></p>
          <p>超級管理員: admin / admin</p>
          <p>團隊管理員: manager / manager</p>
          <p>一般使用者: member / member</p>
        </div>
      </form>
    </div>
  </div>

  <div id="app" class="hidden h-screen bg-slate-800 text-white">
    <aside id="sidebar"
      class="w-64 h-full flex-shrink-0 bg-slate-800 flex flex-col transition-transform duration-300 ease-in-out lg:translate-x-0 -translate-x-full absolute lg:relative z-40">
      <div class="h-16 flex items-center justify-center px-4 border-b border-slate-700">
        <img src="LOGO.png" alt="Control Plane Logo" class="h-8 w-auto">
        <h1 class="text-xl font-bold ml-2">Control Plane</h1>
      </div>
      <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
        <!-- Standalone Item -->
        <a href="#"
          class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200 active"
          data-page="dashboard">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3">
            <path d="M21 12V4a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2v-4"></path>
            <path d="M16 12h-4l-2 5h8l-2-5Z"></path>
            <path d="M5 12h.01"></path>
            <path d="M19 12h.01"></path>
          </svg>
          總覽儀表板
        </a>
        <!-- Standalone Item -->
        <a href="#"
          class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
          data-page="logs">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3">
            <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
            <path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
            <path d="M10 9H8"></path>
            <path d="M16 13H8"></path>
            <path d="M16 17H8"></path>
          </svg>
          告警紀錄
        </a>

        <div class="border-t border-slate-700 my-2"></div>

        <!-- Accordion Group: 資源 -->
        <div class="space-y-1">
          <button
            class="submenu-toggle w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200 text-white">
            <span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" class="h-5 w-5 mr-3">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>資源</span>
            <svg class="chevron-icon h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="submenu pl-6 space-y-1">
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="resources">資源管理</a>
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="groups">資源群組</a>
          </div>
        </div>

        <!-- Accordion Group: 組織 -->
        <div class="space-y-1">
          <button
            class="submenu-toggle w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200 text-white">
            <span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" class="h-5 w-5 mr-3">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
              </svg>組織</span>
            <svg class="chevron-icon h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="submenu pl-6 space-y-1">
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="personnel">人員管理</a>
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="teams">團隊管理</a>
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="channels">通知管道</a>
          </div>
        </div>

        <!-- Accordion Group: 告警 -->
        <div class="space-y-1">
          <button
            class="submenu-toggle w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200 text-white">
            <span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" class="h-5 w-5 mr-3">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <path d="M12 9v4" />
                <path d="M12 17h.01" />
              </svg>告警</span>
            <svg class="chevron-icon h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="submenu pl-6 space-y-1">
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="rules">告警規則</a>
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="maintenance">維護時段</a>
          </div>
        </div>

        <!-- Accordion Group: 分析與自動化 -->
        <div class="space-y-1">
          <button
            class="submenu-toggle w-full flex items-center justify-between px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200 text-white">
            <span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" class="h-5 w-5 mr-3">
                <path d="M3 3v18h18" />
                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" />
              </svg>分析與自動化</span>
            <svg class="chevron-icon h-4 w-4 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
              viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="submenu pl-6 space-y-1">
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="automation">自動化</a>
            <a href="#"
              class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
              data-page="capacity">容量規劃</a>
          </div>
        </div>

        <div class="border-t border-slate-700 my-2"></div>

        <!-- Standalone Item -->
        <a href="#"
          class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
          data-page="profile">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3">
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
          個人資料
        </a>
        <!-- Standalone Item -->
        <a href="#"
          class="sidebar-link flex items-center px-4 py-3 rounded-lg hover:bg-slate-700 transition-colors duration-200"
          data-page="settings">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-3">
            <path
              d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
            </path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          系統設定
        </a>
      </nav>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
      <header class="h-16 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-6">
        <div class="flex items-center gap-4">
          <button id="sidebar-toggle" class="text-slate-400 hover:text-white lg:hidden z-50">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
          <div id="breadcrumb" class="text-lg font-semibold text-slate-200">總覽儀表板</div>
        </div>
        <div class="flex items-center space-x-4">
          <div class="relative">
            <button id="notification-btn" class="relative text-slate-400 hover:text-white">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6">
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
              </svg>
              <span id="notification-badge"
                class="absolute -top-2 -right-2 flex items-center justify-center h-5 w-5 rounded-full bg-red-500 text-white text-xs font-bold"></span>
            </button>
            <div id="notification-dropdown"
              class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg border text-slate-800 hidden z-50">
              <div class="p-3 font-semibold text-sm border-b">通知中心</div>
              <div id="notification-list" class="py-1 max-h-80 overflow-y-auto">
              </div>
              <a href="#"
                class="block bg-slate-50 text-center text-sm font-medium text-blue-600 py-2 hover:bg-slate-100 rounded-b-xl">查看所有通知</a>
            </div>
          </div>
          <div class="w-px h-6 bg-slate-700"></div>

          <div class="flex items-center">
            <div>
              <p id="user-name" class="text-sm font-medium">Admin</p>
              <p id="user-dept" class="text-xs text-slate-400">超級管理員</p>
            </div>
          </div>

          <button id="logout-btn" title="登出" class="text-slate-400 hover:text-white p-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </button>
        </div>
      </header>

      <div class="flex-1 overflow-y-auto p-6 md:p-8">

        <section id="page-dashboard" class="page">
          <div class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="bg-red-50 border-l-4 border-red-500 rounded-r-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-bold text-red-800">新告警 (New)</h4>
                    <p id="dashboard-new-alerts" class="text-3xl font-extrabold text-red-600 mt-2"></p>
                  </div>
                  <div id="new-alerts-trend" class="text-right">
                    <span class="text-xs font-medium text-red-600">與昨日比較</span>
                    <div class="flex items-center justify-end mt-1">
                      <span class="text-sm font-semibold text-red-600">+15%</span>
                      <svg class="w-4 h-4 ml-1 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                          d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                          clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
              <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-bold text-yellow-800">處理中 (In Progress)</h4>
                    <p id="dashboard-ack-alerts" class="text-3xl font-extrabold text-yellow-600 mt-2"></p>
                  </div>
                  <div id="ack-alerts-trend" class="text-right">
                    <span class="text-xs font-medium text-yellow-600">與昨日比較</span>
                    <div class="flex items-center justify-end mt-1">
                      <span class="text-sm font-semibold text-green-600">-8%</span>
                      <svg class="w-4 h-4 ml-1 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                          d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z"
                          clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
              <div class="bg-green-50 border-l-4 border-green-500 rounded-r-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <h4 class="font-bold text-green-800">今日已解決 (Resolved Today)</h4>
                    <p id="dashboard-resolved-alerts" class="text-3xl font-extrabold text-green-600 mt-2"></p>
                  </div>
                  <div id="resolved-alerts-trend" class="text-right">
                    <span class="text-xs font-medium text-green-600">與昨日比較</span>
                    <div class="flex items-center justify-end mt-1">
                      <span class="text-sm font-semibold text-green-600">+22%</span>
                      <svg class="w-4 h-4 ml-1 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                          d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z"
                          clip-rule="evenodd"></path>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div
              class="bg-white p-6 rounded-xl shadow-md flex items-center transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="p-3 rounded-full bg-green-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="h-6 w-6 text-green-600">
                  <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                  <path d="m9 12 2 2 4-4"></path>
                </svg>
              </div>
              <div class="ml-4">
                <p class="text-sm text-slate-500">資源妥善率</p>
                <p class="text-2xl font-bold text-slate-800">99.8%</p>
              </div>
            </div>
            <div
              class="bg-white p-6 rounded-xl shadow-md flex items-center transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="p-3 rounded-full bg-blue-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="h-6 w-6 text-blue-600">
                  <path
                    d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L8.6 3.3A2 2 0 0 0 6.9 2H4a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h16z">
                  </path>
                </svg>
              </div>
              <div class="ml-4">
                <p class="text-sm text-slate-500">總資源數</p>
                <p class="text-2xl font-bold text-slate-800">1,204</p>
              </div>
            </div>
            <div
              class="bg-white p-6 rounded-xl shadow-md flex items-center transition-all duration-300 hover:shadow-lg hover:-translate-y-1">
              <div class="p-3 rounded-full bg-yellow-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="h-6 w-6 text-yellow-600">
                  <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.3.05-3.18-.65-.87-2.1-.82-3.18.05Z">
                  </path>
                  <path
                    d="m12 15-3-3a2.5 2.5 0 0 1 0-3.5A2.5 2.5 0 0 1 12.5 6H13a2 2 0 0 1 2 2v1.5a2.5 2.5 0 0 1-2.5 2.5Z">
                  </path>
                  <path
                    d="m19.5 16.5-3-3a2.5 2.5 0 0 1 0-3.5A2.5 2.5 0 0 1 20.5 6H21a2 2 0 0 1 2 2v1.5a2.5 2.5 0 0 1-2.5 2.5Z">
                  </path>
                </svg>
              </div>
              <div class="ml-4">
                <p class="text-sm text-slate-500">平均網路延遲</p>
                <p class="text-2xl font-bold text-slate-800">23 ms</p>
              </div>
            </div>
          </div>

          <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
              <h3 class="text-lg font-semibold text-slate-800 mb-4">資源群組狀態總覽</h3>
              <div class="relative h-80">
                <canvas id="groupStatusChart"></canvas>
              </div>
            </div>
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
              <h3 class="text-lg font-semibold text-slate-800 mb-4">資源狀態分佈</h3>
              <div class="relative h-80">
                <canvas id="statusChart"></canvas>
              </div>
            </div>
          </div>
        </section>

        <section id="page-resources" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
              <div id="batch-operations-bar" class="hidden">
                <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <span class="text-sm font-medium text-blue-800 whitespace-nowrap">已選取 <span id="selected-count">0</span> 個資源</span>
                  <div class="flex items-center space-x-2 ml-4">
                    <button id="batch-add-to-group-btn"
                      class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors text-sm">加入群組</button>
                    <button id="batch-remove-from-group-btn"
                      class="px-3 py-1.5 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold transition-colors text-sm">移出群組</button>
                    <button id="batch-delete-btn"
                      class="px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold transition-colors text-sm">刪除</button>
                    <button id="clear-selection-btn"
                      class="px-3 py-1.5 bg-slate-500 text-white rounded-lg hover:bg-slate-600 font-semibold transition-colors text-sm">清除</button>
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-2 flex-grow justify-end">
                <input type="text" id="resource-search-input" placeholder="搜尋資源名稱或 IP..."
                  class="w-full md:w-64 px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                <button id="scan-network-btn"
                  class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors text-sm whitespace-nowrap">掃描網段</button>
                <button id="add-resource-btn"
                  class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors text-sm whitespace-nowrap">新增資源</button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-500 rwd-table">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                  <tr>
                    <th scope="col" class="px-2 py-3"><input type="checkbox" id="select-all-resources"
                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></th>
                    <th scope="col" class="px-6 py-3">狀態</th>
                    <th scope="col" class="px-6 py-3">資源名稱</th>
                    <th scope="col" class="px-6 py-3">IP 位址</th>
                    <th scope="col" class="px-6 py-3">所屬群組</th>
                    <th scope="col" class="px-6 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody id="resources-table-body">
                </tbody>
              </table>
            </div>
            <div id="resources-pagination" class="mt-6 flex justify-end items-center space-x-2 text-sm">
            </div>
          </div>
        </section>

        <section id="page-groups" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <div class="w-full md:w-auto"></div>
              <button id="add-group-btn"
                class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors w-full md:w-auto text-sm">新增群組</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-500 rwd-table">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                  <tr>
                    <th scope="col" class="px-6 py-3">群組名稱</th>
                    <th scope="col" class="px-6 py-3">資源數量</th>
                    <th scope="col" class="px-6 py-3">說明</th>
                    <th scope="col" class="px-6 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody id="groups-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-teams" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <div class="w-full md:w-auto"></div>
              <button id="add-team-btn"
                class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors w-full md:w-auto text-sm">新增團隊</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-500 rwd-table">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                  <tr>
                    <th scope="col" class="px-6 py-3">團隊名稱</th>
                    <th scope="col" class="px-6 py-3">團隊管理員</th>
                    <th scope="col" class="px-6 py-3">成員數量</th>
                    <th scope="col" class="px-6 py-3">通知訂閱者</th>
                    <th scope="col" class="px-6 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody id="teams-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-rules" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <div class="w-full md:w-auto"></div>
              <button id="add-rule-btn"
                class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors w-full md:w-auto text-sm">新增告警規則</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-500 rwd-table">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                  <tr>
                    <th scope="col" class="px-6 py-3">規則名稱</th>
                    <th scope="col" class="px-6 py-3">監控目標</th>
                    <th scope="col" class="px-6 py-3">指標</th>
                    <th scope="col" class="px-6 py-3">啟用狀態</th>
                    <th scope="col" class="px-6 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody id="rules-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-personnel" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <div class="w-full md:w-auto"></div>
              <button id="add-user-btn"
                class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors w-full md:w-auto text-sm">新增人員</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-500 rwd-table">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                  <tr>
                    <th scope="col" class="px-6 py-3">姓名</th>
                    <th scope="col" class="px-6 py-3">角色</th>
                    <th scope="col" class="px-6 py-3">所屬團隊</th>
                    <th scope="col" class="px-6 py-3 text-center">接收等級</th>
                    <th scope="col" class="px-6 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody id="personnel-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-channels" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-col md:flex-row justify-end items-center mb-6 gap-4">
              <button id="add-channel-btn"
                class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors w-full md:w-auto text-sm">新增管道</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-500 rwd-table">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                  <tr>
                    <th scope="col" class="px-6 py-3">管道名稱</th>
                    <th scope="col" class="px-6 py-3">管道類型</th>
                    <th scope="col" class="px-6 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody id="channels-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </section>


        <section id="page-maintenance" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <div class="w-full md:w-auto"></div>
              <button id="add-maintenance-btn"
                class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors w-full md:w-auto text-sm">新增維護時段</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-500 rwd-table">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                  <tr>
                    <th scope="col" class="px-6 py-3">說明</th>
                    <th scope="col" class="px-6 py-3">影響群組</th>
                    <th scope="col" class="px-6 py-3">開始時間</th>
                    <th scope="col" class="px-6 py-3">結束時間</th>
                    <th scope="col" class="px-6 py-3">狀態</th>
                    <th scope="col" class="px-6 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody id="maintenance-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-settings" class="page hidden">
          <div class="">
            <div class="bg-white p-6 rounded-xl shadow-md">
              <!-- Tab Navigation -->
              <div class="border-b border-gray-200 mb-6">
                <nav id="settings-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                  <button data-tab="integration"
                    class="settings-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">整合設定</button>
                  <button data-tab="notification"
                    class="settings-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">通知設定</button>
                </nav>
              </div>

              <!-- Tab Content -->
              <div class="mt-2">
                <div id="tab-integration" class="settings-tab-content space-y-8">
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                      <label for="grafana-url" class="text-sm font-medium text-slate-700">Grafana URL</label>
                      <input type="text" id="grafana-url"
                        class="md:col-span-2 mt-1 block w-full rounded-md border-slate-400 bg-slate-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-800"
                        placeholder="https://grafana.example.com">
                    </div>
                  </div>
                </div>

                <div id="tab-notification" class="settings-tab-content hidden space-y-8">
                  <div class="space-y-8">
                    <div>
                      <h3 class="text-lg font-semibold text-slate-800 border-b pb-4 mb-6">郵件伺服器 (SMTP) 設定</h3>
                      <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                          <label for="smtp-server" class="text-sm font-medium text-slate-700">SMTP 伺服器</label>
                          <input type="text" id="smtp-server"
                            class="md:col-span-2 mt-1 block w-full rounded-md border-slate-400 bg-slate-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-800"
                            placeholder="smtp.example.com">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                          <label for="smtp-port" class="text-sm font-medium text-slate-700">端口 (Port)</label>
                          <input type="number" id="smtp-port"
                            class="md:col-span-2 mt-1 block w-full rounded-md border-slate-400 bg-slate-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-800"
                            placeholder="587">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                          <label for="smtp-user" class="text-sm font-medium text-slate-700">使用者名稱</label>
                          <input type="text" id="smtp-user"
                            class="md:col-span-2 mt-1 block w-full rounded-md border-slate-400 bg-slate-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-800"
                            placeholder="user@example.com">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                          <label for="smtp-pass" class="text-sm font-medium text-slate-700">密碼</label>
                          <input type="password" id="smtp-pass"
                            class="md:col-span-2 mt-1 block w-full rounded-md border-slate-400 bg-slate-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-800">
                        </div>
                      </div>
                    </div>
                    <div>
                      <h3 class="text-lg font-semibold text-slate-800 border-b pb-4 mb-6">SMS 閘道設定 (SMS Gateway
                        Settings)
                      </h3>
                      <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                          <label for="sms-provider" class="text-sm font-medium text-slate-700">服務提供商 (Service
                            Provider)</label>
                          <select id="sms-provider"
                            class="md:col-span-2 mt-1 block w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 focus:border-blue-500 focus:ring-blue-500">
                            <option>Twilio</option>
                            <option>Another Provider</option>
                          </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                          <label for="sms-sid" class="text-sm font-medium text-slate-700">帳號 SID (Account SID)</label>
                          <input type="text" id="sms-sid"
                            class="md:col-span-2 mt-1 block w-full rounded-md border-slate-400 bg-slate-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-800"
                            placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                          <label for="sms-token" class="text-sm font-medium text-slate-700">認證權杖 (Auth Token)</label>
                          <input type="password" id="sms-token"
                            class="md:col-span-2 mt-1 block w-full rounded-md border-slate-400 bg-slate-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-800">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                          <label for="sms-from" class="text-sm font-medium text-slate-700">發送號碼 (From Number)</label>
                          <input type="text" id="sms-from"
                            class="md:col-span-2 mt-1 block w-full rounded-md border-slate-400 bg-slate-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm text-slate-800"
                            placeholder="+15017122661">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="flex justify-end mt-8">
                  <button id="save-settings-btn"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors">儲存設定</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="page-logs" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <div class="w-full md:w-auto"></div>
              <div class="flex items-center space-x-2 w-full md:w-auto flex-wrap gap-2 justify-end">
                <input type="date" id="logs-start-date"
                  class="px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                <span class="text-slate-500">至</span>
                <input type="date" id="logs-end-date"
                  class="px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                <select id="logs-level-filter"
                  class="px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm bg-white text-slate-800">
                  <option value="">所有等級</option>
                  <option value="error">高 (錯誤)</option>
                  <option value="warning">中 (警告)</option>
                  <option value="info">低 (資訊)</option>
                </select>
                <select id="logs-status-filter"
                  class="px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm bg-white text-slate-800">
                  <option value="">所有狀態</option>
                  <option value="new">新告警</option>
                  <option value="ack">處理中</option>
                  <option value="resolved">已解決</option>
                </select>
                <button id="query-logs-btn"
                  class="px-3 py-1.5 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-semibold transition-colors text-sm">查詢</button>
                <button id="generate-report-btn" disabled
                  class="px-3 py-1.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold disabled:bg-purple-300 disabled:cursor-not-allowed flex items-center gap-2 transition-colors text-sm">
                  ✨ 生成事件報告
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-slate-500 rwd-table">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                  <tr>
                    <th scope="col" class="px-2 py-3"><input type="checkbox" id="select-all-logs"></th>
                    <th scope="col" class="px-6 py-3">等級</th>
                    <th scope="col" class="px-6 py-3">時間</th>
                    <th scope="col" class="px-6 py-3">狀態</th>
                    <th scope="col" class="px-6 py-3">資源名稱</th>
                    <th scope="col" class="px-6 py-3">處理人員</th>
                    <th scope="col" class="px-6 py-3">說明</th>
                    <th scope="col" class="px-6 py-3 text-center">操作</th>
                  </tr>
                </thead>
                <tbody id="logs-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- NEW: Automation Page Section -->
        <section id="page-automation" class="page hidden">
          <div class="bg-white p-6 rounded-xl shadow-md">
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
              <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="scripts-tab"
                  class="automation-tab border-blue-600 text-blue-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                  腳本庫
                </button>
                <button id="execution-logs-tab"
                  class="automation-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                  執行日誌
                </button>
              </nav>
            </div>

            <!-- Scripts Library Tab -->
            <div id="scripts-content" class="automation-content">
              <div class="flex flex-col md:flex-row justify-end items-center mb-6 gap-4">
                <button id="add-script-btn"
                  class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors w-full md:w-auto text-sm">新增腳本</button>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500 rwd-table">
                  <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                    <tr>
                      <th scope="col" class="px-6 py-3">腳本名稱</th>
                      <th scope="col" class="px-6 py-3">類型</th>
                      <th scope="col" class="px-6 py-3">描述</th>
                      <th scope="col" class="px-6 py-3">最後更新</th>
                      <th scope="col" class="px-6 py-3 text-center">操作</th>
                    </tr>
                  </thead>
                  <tbody id="scripts-table-body">
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Execution Logs Tab -->
            <div id="execution-logs-content" class="automation-content hidden">
              <div class="flex flex-col md:flex-row justify-end items-center mb-6 gap-4">
                <div class="flex items-center space-x-2">
                  <input type="date" id="log-start-date"
                    class="px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                  <span class="text-slate-500">至</span>
                  <input type="date" id="log-end-date"
                    class="px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                  <select id="log-status-filter"
                    class="px-3 py-1.5 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">所有狀態</option>
                    <option value="success">成功</option>
                    <option value="failed">失敗</option>
                  </select>
                  <button id="filter-logs-btn"
                    class="px-3 py-1.5 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-semibold transition-colors text-sm">篩選</button>
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500 rwd-table">
                  <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                    <tr>
                      <th scope="col" class="px-6 py-3">執行時間</th>
                      <th scope="col" class="px-6 py-3">腳本名稱</th>
                      <th scope="col" class="px-6 py-3">觸發告警</th>
                      <th scope="col" class="px-6 py-3">執行狀態</th>
                      <th scope="col" class="px-6 py-3">執行時長</th>
                      <th scope="col" class="px-6 py-3 text-center">操作</th>
                    </tr>
                  </thead>
                  <tbody id="execution-logs-table-body">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- NEW: Capacity Planning Page Section -->
        <section id="page-capacity" class="page hidden">
          <div class="space-y-6">
            <!-- Control Panel -->
            <div class="bg-white p-6 rounded-xl shadow-md">
              <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-2">選擇目標群組</label>
                  <select id="capacity-target-group"
                    class="w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 focus:border-blue-500 focus:ring-blue-500">
                    <option value="">請選擇資源群組</option>
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-slate-700 mb-2">選擇指標</label>
                  <select id="capacity-metric"
                    class="w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 focus:border-blue-500 focus:ring-blue-500">
                    <option value="">請先選擇群組</option>
                  </select>
                </div>
                <div>
                  <button id="analyze-capacity-btn"
                    class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold transition-colors disabled:bg-purple-300 disabled:cursor-not-allowed"
                    disabled>
                    開始分析
                  </button>
                </div>
              </div>
            </div>

            <!-- Analysis Results -->
            <div id="capacity-results" class="hidden space-y-6">
              <!-- Key Metrics Cards -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                  <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="h-6 w-6 text-blue-600">
                        <path d="M3 3v18h18"></path>
                        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                      </svg>
                    </div>
                    <div class="ml-4">
                      <p class="text-sm text-slate-500">平均月增長率</p>
                      <p id="growth-rate" class="text-2xl font-bold text-slate-800">--</p>
                    </div>
                  </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                  <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="h-6 w-6 text-yellow-600">
                        <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                        <path d="M12 6v6l4 2"></path>
                      </svg>
                    </div>
                    <div class="ml-4">
                      <p class="text-sm text-slate-500">預計達到80%警戒線</p>
                      <p id="warning-eta" class="text-2xl font-bold text-slate-800">--</p>
                    </div>
                  </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                  <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="h-6 w-6 text-red-600">
                        <path
                          d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
                        </path>
                        <path d="M12 9v4"></path>
                        <path d="M12 17h.01"></path>
                      </svg>
                    </div>
                    <div class="ml-4">
                      <p class="text-sm text-slate-500">預計資源耗盡</p>
                      <p id="depletion-eta" class="text-2xl font-bold text-slate-800">--</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Trend Chart -->
              <div class="bg-white p-6 rounded-xl shadow-md">
                <h4 class="text-lg font-semibold text-slate-800 mb-4">歷史趨勢與未來預測</h4>
                <div class="relative h-96">
                  <canvas id="capacityTrendChart"></canvas>
                </div>
              </div>

              <!-- Recommendations -->
              <div class="bg-white p-6 rounded-xl shadow-md">
                <h4 class="text-lg font-semibold text-slate-800 mb-4">建議措施</h4>
                <div id="capacity-recommendations" class="space-y-3">
                  <!-- Recommendations will be populated here -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- NEW: Profile Page Section -->
        <section id="page-profile" class="page hidden">
          <div class="">
            <div class="bg-white p-6 rounded-xl shadow-md">
              <!-- Tab Navigation -->
              <div class="border-b border-gray-200 mb-6">
                <nav id="profile-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                  <button data-tab="info"
                    class="profile-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">個人資訊</button>
                  <button data-tab="security"
                    class="profile-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">密碼安全</button>
                  <button data-tab="notifications"
                    class="profile-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">通知設定</button>
                </nav>
              </div>

              <!-- Tab Content -->
              <div class="mt-2">
                <div id="tab-info" class="profile-tab-content">
                  <!-- Personal Info Card -->
                  <div class="space-y-4 text-sm">
                    <div class="grid grid-cols-1 md:grid-cols-4 items-center gap-4">
                      <label for="profile-name-input" class="font-medium text-slate-700">姓名</label>
                      <input type="text" id="profile-name-input"
                        class="md:col-span-3 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 items-center gap-4">
                      <label class="font-medium text-slate-500">角色</label>
                      <p id="profile-role" class="md:col-span-3 text-slate-800"></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 items-start gap-4">
                      <label class="font-medium text-slate-700 pt-1">所屬團隊</label>
                      <div id="profile-teams-tags" class="md:col-span-3 flex flex-wrap gap-2"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 items-center gap-4">
                      <label for="profile-language-select" class="font-medium text-slate-700">語言</label>
                      <select id="profile-language-select"
                        class="md:col-span-3 mt-1 block w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 focus:border-blue-500 focus:ring-blue-500">
                        <option>繁體中文</option>
                        <option>English</option>
                      </select>
                    </div>
                  </div>
                  <div class="flex justify-end mt-6">
                    <button id="save-profile-info-btn"
                      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors text-sm">更新資訊</button>
                  </div>
                </div>
                <div id="tab-security" class="profile-tab-content hidden space-y-8">
                  <!-- Change Password Card -->
                  <h3 class="text-lg font-semibold text-slate-800 border-b pb-4 mb-6">變更密碼</h3>
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 items-center gap-4">
                      <label for="current-password" class="text-sm font-medium text-slate-700">目前密碼</label>
                      <input type="password" id="current-password"
                        class="md:col-span-3 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 items-center gap-4">
                      <label for="new-password" class="text-sm font-medium text-slate-700">新密碼</label>
                      <input type="password" id="new-password"
                        class="md:col-span-3 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 items-center gap-4">
                      <label for="confirm-password" class="text-sm font-medium text-slate-700">確認新密碼</label>
                      <input type="password" id="confirm-password"
                        class="md:col-span-3 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                  </div>
                  <div class="flex justify-end mt-6">
                    <button id="save-password-btn"
                      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors text-sm">更新密碼</button>
                  </div>
                </div>
                <div id="tab-notifications" class="profile-tab-content hidden space-y-8">
                  <!-- Contact Info Card -->
                  <h3 class="text-lg font-semibold text-slate-800 border-b pb-4 mb-6">聯絡方式</h3>
                  <div id="contact-methods-container" class="space-y-4">
                    <!-- Email -->
                    <div class="grid grid-cols-1 md:grid-cols-4 items-center gap-4">
                      <label for="profile-email" class="text-sm font-medium text-slate-700">Email</label>
                      <div class="md:col-span-3 flex items-center gap-x-3">
                        <input type="email" id="profile-email"
                          class="flex-grow block w-full rounded-md border-slate-300 shadow-sm sm:text-sm"
                          placeholder="用於接收 Email 通知">
                        <span id="email-status" class="text-sm font-medium w-20 text-center flex-shrink-0"></span>
                        <button id="email-action-btn" data-method="email" data-action="save"
                          class="w-28 justify-center px-3 py-1.5 rounded-lg font-semibold transition-colors text-sm flex-shrink-0">儲存</button>
                      </div>
                    </div>
                    <!-- LINE Notify -->
                    <div class="grid grid-cols-1 md:grid-cols-4 items-center gap-4">
                      <label for="profile-line-token" class="text-sm font-medium text-slate-700">LINE Notify
                        Token</label>
                      <div class="md:col-span-3 flex items-center gap-x-3">
                        <input type="text" id="profile-line-token"
                          class="flex-grow block w-full rounded-md border-slate-300 shadow-sm sm:text-sm"
                          placeholder="用於接收 LINE 通知">
                        <span id="line-token-status" class="text-sm font-medium w-20 text-center flex-shrink-0"></span>
                        <button id="line-token-action-btn" data-method="line-token" data-action="save"
                          class="w-28 justify-center px-3 py-1.5 rounded-lg font-semibold transition-colors text-sm flex-shrink-0">儲存</button>
                      </div>
                    </div>
                    <!-- SMS -->
                    <div class="grid grid-cols-1 md:grid-cols-4 items-start gap-4">
                      <label for="profile-sms" class="text-sm font-medium text-slate-700 pt-2">SMS 手機號碼</label>
                      <div class="md:col-span-3 space-y-2">
                        <div class="flex items-center gap-x-3">
                          <input type="text" id="profile-sms"
                            class="flex-grow block w-full rounded-md border-slate-300 shadow-sm sm:text-sm"
                            placeholder="用於接收個人簡訊通知">
                          <span id="sms-status" class="text-sm font-medium w-20 text-center flex-shrink-0"></span>
                          <button id="sms-action-btn" data-method="sms" data-action="save"
                            class="w-28 justify-center px-3 py-1.5 rounded-lg font-semibold transition-colors text-sm flex-shrink-0">儲存</button>
                        </div>
                        <div id="sms-verify-container" class="hidden flex items-center gap-x-3">
                          <input type="text" id="sms-verify-code"
                            class="flex-grow block w-full rounded-md border-slate-300 shadow-sm sm:text-sm"
                            placeholder="請輸入收到的 6 位數驗證碼">
                          <button id="sms-verify-btn"
                            class="w-28 justify-center px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold transition-colors text-sm flex-shrink-0">確認驗證碼</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Notification Preferences Card -->
                  <h3 class="text-lg font-semibold text-slate-800 border-b pb-4 mb-6 mt-8">通知偏好</h3>
                  <p class="text-sm text-slate-600 mb-4">選擇您希望透過以上管道接收的告警等級。</p>
                  <div class="space-y-3">
                    <div class="relative flex items-start">
                      <div class="flex h-6 items-center"><input id="pref-high" name="alert-level" type="checkbox"
                          class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-600"></div>
                      <div class="ml-3 text-sm leading-6">
                        <label for="pref-high" class="font-medium text-slate-900 cursor-pointer">
                          <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-800">高
                          </span>
                        </label>
                        <p class="text-slate-500">僅接收最緊急的事件，例如服務中斷。</p>
                      </div>
                    </div>
                    <div class="relative flex items-start">
                      <div class="flex h-6 items-center"><input id="pref-medium" name="alert-level" type="checkbox"
                          class="h-4 w-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-600"></div>
                      <div class="ml-3 text-sm leading-6">
                        <label for="pref-medium" class="font-medium text-slate-900 cursor-pointer">
                          <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800">中
                          </span>
                        </label>
                        <p class="text-slate-500">接收可能影響服務的警告，例如資源使用率過高。</p>
                      </div>
                    </div>
                    <div class="relative flex items-start">
                      <div class="flex h-6 items-center"><input id="pref-low" name="alert-level" type="checkbox"
                          class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div>
                      <div class="ml-3 text-sm leading-6">
                        <label for="pref-low" class="font-medium text-slate-900 cursor-pointer">
                          <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-800">低
                          </span>
                        </label>
                        <p class="text-slate-500">接收所有資訊型通知。</p>
                      </div>
                    </div>
                  </div>
                  <div class="flex justify-end mt-6">
                    <button id="save-prefs-btn"
                      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors text-sm">儲存偏好設定</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <div id="form-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300 opacity-0">
    <div
      class="bg-white rounded-xl shadow-2xl w-11/12 md:w-1/2 max-w-lg flex flex-col transform transition-all duration-300 scale-95">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 id="form-modal-title" class="text-lg font-bold text-slate-800">Modal Title</h3>
        <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
      </div>
      <div id="form-modal-body" class="p-6">
      </div>
      <div class="p-4 border-t bg-slate-50 rounded-b-xl flex justify-end space-x-2">
        <button
          class="close-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold transition-colors">取消</button>
        <button id="form-modal-save-btn"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors">儲存</button>
      </div>
    </div>
  </div>

  <div id="confirm-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300 opacity-0">
    <div
      class="bg-white rounded-xl shadow-2xl w-11/12 max-w-sm flex flex-col transform transition-all duration-300 scale-95">
      <div class="p-6 text-center">
        <svg class="mx-auto mb-4 text-yellow-500 w-12 h-12" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
        <h3 id="confirm-modal-text" class="mb-5 text-lg font-normal text-slate-600">您確定嗎？</h3>
        <button id="confirm-action-btn"
          class="text-white bg-yellow-600 hover:bg-yellow-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2 transition-colors">確定</button>
        <button id="cancel-action-btn"
          class="text-slate-500 bg-white hover:bg-slate-100 rounded-lg border border-slate-200 text-sm font-medium px-5 py-2.5 hover:text-slate-900 focus:z-10 transition-colors">取消</button>
      </div>
    </div>
  </div>


  <div id="gemini-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300 opacity-0">
    <div
      class="bg-white rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
          <svg class="h-6 w-6 text-purple-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            fill="currentColor">
            <path
              d="M12.5455 1.52273C12.3386 0.625 11.6614 0.625 11.4545 1.52273L11 3.5H9C8.44772 3.5 8 3.94772 8 4.5C8 5.05228 8.44772 5.5 9 5.5H11L11.4545 7.47727C11.6614 8.375 12.3386 8.375 12.5455 7.47727L13 5.5H15C15.5523 5.5 16 5.05228 16 4.5C16 3.94772 15.5523 3.5 15 3.5H13L12.5455 1.52273Z M6.54545 4.52273C6.33864 3.625 5.66136 3.625 5.45455 4.52273L5 6.5H4C3.44772 6.5 3 6.94772 3 7.5C3 8.05228 3.44772 8.5 4 8.5H5L5.45455 10.4773C5.66136 11.375 6.33864 11.375 6.54545 10.4773L7 8.5H8C8.55228 8.5 9 8.05228 9 7.5C9 6.94772 8.55228 6.5 8 6.5H7L6.54545 4.52273Z M18.5455 12.5227C18.3386 11.625 17.6614 11.625 17.4545 12.5227L17 14.5H16C15.4477 14.5 15 14.9477 15 15.5C15 16.0523 15.4477 16.5 16 16.5H17L17.4545 18.4773C17.6614 19.375 18.3386 19.375 18.5455 18.4773L19 16.5H20C20.5523 16.5 21 16.0523 21 15.5C21 14.9477 20.5523 14.5 20 14.5H19L18.5455 12.5227Z">
            </path>
          </svg>
          <span>Gemini AI 分析報告</span>
        </h3>
        <button id="close-gemini-modal"
          class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
      </div>
      <div id="gemini-modal-content" class="p-6 overflow-y-auto text-slate-700">
      </div>
      <div class="p-4 border-t bg-slate-50 rounded-b-xl">
        <button id="copy-report-btn"
          class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-semibold transition-colors">複製報告</button>
      </div>
    </div>
  </div>

  <div id="incident-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300 opacity-0">
    <div
      class="bg-white rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 id="incident-modal-title" class="text-lg font-bold text-slate-800">事件詳情</h3>
        <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
      </div>
      <div id="incident-modal-body" class="p-6 overflow-y-auto text-slate-700">
      </div>
      <div class="p-4 border-t bg-slate-50 rounded-b-xl flex justify-end space-x-2">
        <button
          class="close-modal-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold transition-colors">關閉</button>
      </div>
    </div>
  </div>

  <div id="feedback-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 transition-opacity duration-300 opacity-0">
    <div
      class="bg-white rounded-xl shadow-2xl w-auto max-w-sm flex items-center p-6 space-x-4 transform transition-all duration-300 scale-95">
      <div class="flex-shrink-0">
        <svg class="h-8 w-8 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
          stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div>
        <div id="feedback-modal-text" class="text-lg font-semibold text-slate-700"></div>
      </div>
    </div>
  </div>


  <script>
    // --- Enhanced Mock Data ---
    const mockUsers = {
      // MODIFIED: Added contact info and preferences
      admin: { pass: 'admin', role: 'SuperAdmin', name: 'Admin', dept: '超級管理員', avatar: 'A', email: 'admin@corp.com', emailVerified: true, lineToken: 'ABC123xyz', lineVerified: true, sms: '+15551234567', smsVerified: true, subscribedLevels: ['high', 'medium', 'low'] },
      manager: { pass: 'manager', role: 'TeamManager', name: '林組長', dept: '網路團隊', avatar: 'L', managesTeamIds: [1], email: 'manager.lin@corp.com', emailVerified: true, lineToken: '', lineVerified: false, sms: '', smsVerified: false, subscribedLevels: ['high', 'medium'] },
      member: { pass: 'member', role: 'TeamMember', name: '王工程師', dept: '網路團隊', avatar: 'W', teamIds: [1, 2], email: 'wang.pe@corp.com', emailVerified: false, lineToken: 'DEF456uvw', lineVerified: true, sms: '+15557654321', smsVerified: false, subscribedLevels: ['high'] }
    };

    let loggedInUser = null;

    const mockData = {
      systemSettings: {
        grafanaUrl: 'https://grafana.example.com',
        smtp: {
          server: 'smtp.example.com',
          port: 587,
          user: 'user@example.com',
          pass: 'password123'
        }
      },
      branches: [
        { name: '仁愛分行', region: '北區', status: 'normal', resources: { total: 50, error: 0, warning: 1 } },
        { name: '林口分行', region: '北區', status: 'error', resources: { total: 35, error: 2, warning: 1 } },
        { name: '信義分行', region: '北區', status: 'normal', resources: { total: 60, error: 0, warning: 0 } },
        { name: '台中分行', region: '中區', status: 'normal', resources: { total: 45, error: 0, warning: 0 } },
        { name: '台南分行', region: '南區', status: 'warning', resources: { total: 40, error: 0, warning: 3 } },
        { name: '高雄分行', region: '南區', status: 'normal', resources: { total: 55, error: 0, warning: 0 } },
      ],
      resources: [
        { id: 1, status: 'normal', name: 'Edge SW13', ip: '88.201.0.13', branch: '仁愛分行', type: 'Switch', groupIds: [1] },
        { id: 2, status: 'warning', name: 'Backup Server', ip: '88.201.0.14', branch: '仁愛分行', type: 'Server', groupIds: [] },
        { id: 3, status: 'error', name: 'DATA Router', ip: '88.255.252.101', branch: '林口分行', type: 'Router', groupIds: [3] },
        { id: 4, status: 'normal', name: 'VG Router', ip: '88.99.33.12', branch: '林口分行', type: 'Router', groupIds: [3] },
        { id: 5, status: 'error', name: 'Delta PDU', ip: '88.99.33.15', branch: '林口分行', type: 'Server', groupIds: [] },
        { id: 6, status: 'normal', name: 'Core Switch', ip: '88.99.0.10', branch: '林口分行', type: 'Switch', groupIds: [1] },
        { id: 7, status: 'warning', name: 'Firewall-A', ip: '121.55.2.1', branch: '台南分行', type: 'Firewall', groupIds: [2] },
        { id: 8, status: 'warning', name: 'AP-Lobby', ip: '121.55.2.100', branch: '台南分行', type: 'AP', groupIds: [] },
        { id: 9, status: 'warning', name: 'AP-MeetingRoom', ip: '121.55.2.101', branch: '台南分行', type: 'AP', groupIds: [] },
      ],
      resourceGroups: [
        { id: 1, name: '核心交換器', description: '所有分行的核心網路交換器', memberIds: [1, 6] },
        { id: 2, name: '總公司防火牆', description: '總部對外防火牆資源', memberIds: [7] },
        { id: 3, name: '所有路由器', description: '包含所有分行的路由器', memberIds: [3, 4] },
      ],
      alertRules: [
        { id: 1, name: '核心交換器 CPU 過高', target: '群組: 核心交換器', metric: 'CPU 使用率', enabled: true, silencedUntil: null },
        { id: 2, name: '防火牆網路流量異常', target: '群組: 總公司防火牆', metric: '網路流量', enabled: true, silencedUntil: '2025-08-28T18:00:00' },
        { id: 3, name: '仁愛分行-Router-延遲', target: '資源: DATA Router', metric: '網路延遲 (Ping)', enabled: false, silencedUntil: null },
      ],
      notificationChannels: [
        { id: 1, name: '網路一部 Slack', type: 'webhook', url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX' },
        { id: 2, name: 'On-Call 值班簡訊', type: 'webhook', url: 'https://sms-gateway.com/api/send' },
        { id: 3, name: '預設 Email (SMTP)', type: 'email', url: null },
        { id: 4, name: '資安團隊 Email 群組', type: 'email', url: 'security-alerts@corp.com' }
      ],
      personnel: [
        { id: 1, name: '陳經理', role: 'SuperAdmin', subscribedLevels: ['high', 'medium', 'low'], teamIds: [1, 3], email: 'manager.chen@corp.com', lineToken: 'GHI789jkl' },
        { id: 2, name: '林組長', role: 'TeamManager', subscribedLevels: ['high', 'medium'], teamIds: [1], email: 'manager.lin@corp.com', lineToken: '' },
        { id: 3, name: '王工程師', role: 'TeamMember', subscribedLevels: ['high'], teamIds: [1, 2], email: 'wang.pe@corp.com', lineToken: 'DEF456uvw' },
        { id: 4, name: 'Admin', role: 'SuperAdmin', subscribedLevels: ['high', 'medium', 'low'], teamIds: [1, 2, 3], email: 'admin@corp.com', lineToken: 'ABC123xyz' }
      ],
      teams: [
        { id: 1, name: '網路團隊', managerId: 2, memberIds: [1, 2, 3], accessibleGroupIds: [1, 3], subscribers: [{ type: 'personnel', id: 3 }, { type: 'channel', id: 1 }] },
        { id: 2, name: '伺服器團隊', managerId: null, memberIds: [3], accessibleGroupIds: [], subscribers: [{ type: 'personnel', id: 3 }] },
        { id: 3, name: '資安團隊', managerId: 1, memberIds: [1], accessibleGroupIds: [2], subscribers: [{ type: 'personnel', id: 1 }, { type: 'channel', id: 4 }] },
      ],
      maintenance: [
        { id: 1, name: '週末系統更新', groups: ['核心交換器'], start: '2025-08-30 02:00', end: '2025-08-30 04:00', status: '已排程' }
      ],
      automationScripts: [
        { id: 1, name: '重啟 Web 服務', type: 'Shell Script', description: '自動重啟 Apache/Nginx 服務', lastUpdated: '2025-08-25', parameters: ['host_ip', 'service_name'] },
        { id: 2, name: '清除快取', type: 'Ansible Playbook', description: '清除 Redis 和應用程式快取', lastUpdated: '2025-08-20', parameters: ['cache_type', 'host_group'] },
        { id: 3, name: '磁碟清理', type: 'Python Script', description: '清理暫存檔案和日誌', lastUpdated: '2025-08-15', parameters: ['target_path', 'retention_days'] }
      ],
      executionLogs: [
        { id: 1, executionTime: '2025-08-29 01:20', scriptName: '重啟 Web 服務', triggerAlert: 'Edge SW13 斷線', status: 'success', duration: '15s', output: 'Service restarted successfully\nApache service stopped\nApache service started\nStatus: Active (running)' },
        { id: 2, executionTime: '2025-08-28 22:30', scriptName: '清除快取', triggerAlert: 'Firewall-A CPU 過高', status: 'failed', duration: '8s', output: 'Connection timeout to Redis server\nError: Could not connect to Redis at 127.0.0.1:6379\nConnection refused\nExit code: 1' },
        { id: 3, executionTime: '2025-08-28 18:10', scriptName: '磁碟清理', triggerAlert: '磁碟空間不足', status: 'success', duration: '45s', output: 'Cleaned 2.3GB of temporary files\nRemoved 1,245 log files\nRemoved 892 cache files\nDisk space freed: 2.3GB' },
        { id: 4, executionTime: '2025-08-28 15:45', scriptName: '重啟 Web 服務', triggerAlert: 'HTTP 500 錯誤', status: 'success', duration: '12s', output: 'Service restarted successfully\nNginx service stopped\nNginx service started\nStatus: Active (running)' },
        { id: 5, executionTime: '2025-08-28 14:22', scriptName: '清除快取', triggerAlert: '記憶體使用率過高', status: 'success', duration: '25s', output: 'Cache cleared successfully\nRedis FLUSHALL executed\nMemcached flush_all executed\nMemory usage reduced by 1.2GB' },
        { id: 6, executionTime: '2025-08-28 12:15', scriptName: '磁碟清理', triggerAlert: '磁碟使用率 85%', status: 'success', duration: '38s', output: 'Cleaned 1.8GB of temporary files\nRemoved 756 log files\nRemoved 1,123 cache files\nDisk space freed: 1.8GB' },
        { id: 7, executionTime: '2025-08-28 09:30', scriptName: '重啟 Web 服務', triggerAlert: '服務無回應', status: 'failed', duration: '5s', output: 'Service restart failed\nError: systemctl restart apache2 failed\nJob for apache2.service failed\nExit code: 1' },
        { id: 8, executionTime: '2025-08-27 23:45', scriptName: '清除快取', triggerAlert: '應用程式回應緩慢', status: 'success', duration: '18s', output: 'Cache cleared successfully\nApplication cache cleared\nBrowser cache cleared\nPerformance improved' }
      ],
      capacityMetrics: {
        'cpu_usage': { name: 'CPU 使用率', unit: '%' },
        'memory_usage': { name: '記憶體使用率', unit: '%' },
        'disk_usage': { name: '磁碟使用率', unit: '%' },
        'network_traffic': { name: '網路流量', unit: 'Mbps' }
      },
      logs: [
        { id: 1, level: 'error', time: '2025-08-29 01:15', branch: '仁愛分行', ip: '88.201.0.13', name: 'Edge SW13', desc: '資源斷線超過15分鐘', status: 'new', assignee: null, acknowledgedBy: null, comments: [] },
        { id: 2, level: 'error', time: '2025-08-29 01:10', branch: '仁愛分行', ip: '88.201.0.11', name: 'Edge SW11', desc: '資源斷線超過15分鐘', status: 'new', assignee: null, acknowledgedBy: null, comments: [] },
        { id: 3, level: 'warning', time: '2025-08-28 22:15', branch: '台南分行', ip: '121.55.2.1', name: 'Firewall-A', desc: 'CPU 使用率超過 90%', status: 'ack', assignee: '王工程師', acknowledgedBy: '林組長', comments: [{ user: '林組長', text: '已指派給王工程師處理。', time: '2025-08-28 22:16' }] },
        { id: 4, level: 'warning', time: '2025-08-28 21:30', branch: '林口分行', ip: '88.255.252.101', name: 'DATA Router', desc: '網路延遲超過 200ms', status: 'resolved', assignee: '王工程師', acknowledgedBy: '王工程師', comments: [{ user: '王工程師', text: '已確認為 ISP 線路瞬斷，目前已恢復。', time: '2025-08-28 21:45' }] },
        { id: 5, level: 'info', time: '2025-08-28 18:05', branch: '林口分行', ip: '88.99.33.12', name: 'VG Router', desc: '資源重新啟動', status: 'resolved', assignee: null, acknowledgedBy: null, comments: [] },
        { id: 6, level: 'error', time: '2025-08-28 15:30', branch: '台中分行', ip: '192.168.10.5', name: 'Core Switch01', desc: '記憶體使用率達到 95%', status: 'ack', assignee: '陳經理', acknowledgedBy: '陳經理', comments: [{ user: '陳經理', text: '正在檢查記憶體洩漏問題', time: '2025-08-28 15:35' }] },
        { id: 7, level: 'warning', time: '2025-08-28 14:20', branch: '高雄分行', ip: '172.16.5.10', name: 'Backup Server', desc: '磁碟空間使用率超過 85%', status: 'resolved', assignee: '林組長', acknowledgedBy: '林組長', comments: [{ user: '林組長', text: '已清理舊備份檔案，空間已釋放', time: '2025-08-28 14:45' }] },
        { id: 8, level: 'info', time: '2025-08-28 12:10', branch: '信義分行', ip: '10.0.1.20', name: 'AP-Lobby', desc: '無線網路使用者數量達到上限', status: 'resolved', assignee: null, acknowledgedBy: null, comments: [] },
        { id: 9, level: 'warning', time: '2025-08-28 10:45', branch: '台南分行', ip: '121.55.2.100', name: 'UPS-Main', desc: '電池電量低於 20%', status: 'ack', assignee: '王工程師', acknowledgedBy: '王工程師', comments: [{ user: '王工程師', text: '已聯繫廠商更換電池', time: '2025-08-28 11:00' }] },
        { id: 10, level: 'error', time: '2025-08-27 23:55', branch: '林口分行', ip: '88.99.33.15', name: 'Delta PDU', desc: '服務無回應', status: 'resolved', assignee: '陳經理', acknowledgedBy: '陳經理', comments: [{ user: '陳經理', text: '已重啟服務，問題解決', time: '2025-08-28 00:10' }] },
        { id: 11, level: 'warning', time: '2025-08-27 20:30', branch: '台中分行', ip: '192.168.10.15', name: 'Print Server', desc: '列印佇列堆積超過 50 個工作', status: 'resolved', assignee: '林組長', acknowledgedBy: '林組長', comments: [{ user: '林組長', text: '已清理佇列並重啟服務', time: '2025-08-27 20:45' }] },
        { id: 12, level: 'info', time: '2025-08-27 16:20', branch: '高雄分行', ip: '172.16.5.5', name: 'Web Server', desc: '定期維護完成', status: 'resolved', assignee: null, acknowledgedBy: null, comments: [] }
      ]
    };

    function getPendingAlerts() {
      return mockData.logs.filter(log => log.level === 'error' || log.level === 'warning');
    }

    // --- FIX: Moved showPage to global scope ---
    function showPage(pageId) {
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => {
        page.id === `page-${pageId}` ? page.classList.remove('hidden') : page.classList.add('hidden');
      });
      // Repopulate tables on page change to ensure content is fresh
      populateTables();
    }

    // --- Navigation Logic ---
    document.addEventListener('DOMContentLoaded', function () {
      const links = document.querySelectorAll('.sidebar-link');
      const breadcrumb = document.getElementById('breadcrumb');
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const notificationBtn = document.getElementById('notification-btn');
      const notificationDropdown = document.getElementById('notification-dropdown');

      const accordionToggles = document.querySelectorAll('.submenu-toggle');

      accordionToggles.forEach(toggle => {
        toggle.addEventListener('click', () => {
          // Close other open menus if you want only one open at a time
          // accordionToggles.forEach(otherToggle => {
          //   if (otherToggle !== toggle) {
          //     otherToggle.classList.remove('open');
          //   }
          // });
          toggle.classList.toggle('open');
        });
      });

      links.forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          if (this.style.display === 'none') return;

          const pageId = this.dataset.page;

          // Deactivate all links
          links.forEach(l => l.classList.remove('active'));

          // Activate the clicked link and any other link pointing to the same page
          document.querySelectorAll(`.sidebar-link[data-page="${pageId}"]`).forEach(activeLink => {
            activeLink.classList.add('active');
          });

          // Open parent accordion if inside one
          const parentSubmenu = this.closest('.submenu');
          accordionToggles.forEach(t => t.classList.remove('open')); // Close all
          if (parentSubmenu) {
            const toggle = parentSubmenu.previousElementSibling;
            if (toggle && toggle.classList.contains('submenu-toggle')) {
              toggle.classList.add('open');
            }
          }

          showPage(pageId);

          if (pageId === 'dashboard') {
            renderGroupStatusChart();
          }

          // Use the text from the clicked link for the breadcrumb, or find a better source
          const breadcrumbSource = document.querySelector(`.sidebar-link[data-page="${pageId}"]`);
          breadcrumb.textContent = breadcrumbSource ? breadcrumbSource.textContent.trim() : "個人資料";

          if (window.innerWidth < 1024) {
            sidebar.classList.add('-translate-x-full');
          }
        });
      });

      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('-translate-x-full');
      });

      notificationBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        notificationDropdown.classList.toggle('hidden');
      });

      document.addEventListener('click', () => {
        if (!notificationDropdown.classList.contains('hidden')) {
          notificationDropdown.classList.add('hidden');
        }
      });

      // Login/Logout logic
      const loginPage = document.getElementById('login-page');
      const appDiv = document.getElementById('app');

      document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const user = mockUsers[username];
        if (user && user.pass === pass) {
          loggedInUser = user;
          loginPage.style.display = 'none';
          appDiv.style.display = 'flex';
          renderUI();
        } else {
          document.getElementById('login-error').classList.remove('hidden');
        }
      });

      document.getElementById('logout-btn').addEventListener('click', () => {
        loggedInUser = null;
        appDiv.style.display = 'none';
        loginPage.style.display = 'flex';
        document.getElementById('login-error').classList.add('hidden');
      });


      // Chart.js Initialization
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      new Chart(statusCtx, { type: 'doughnut', data: { labels: ['正常', '警告', '異常'], datasets: [{ data: [1150, 41, 13], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
    });

    let groupStatusChartInstance = null; // To hold the chart instance

    function renderGroupStatusChart() {
      // --- Start of moved logic from getVisibleGroups ---
      if (!loggedInUser) return [];
      const userRole = loggedInUser.role;
      let groupsToRender;

      if (userRole === 'SuperAdmin') {
        groupsToRender = mockData.resourceGroups;
      } else if (userRole === 'TeamManager' || userRole === 'TeamMember') {
        const userInPersonnel = mockData.personnel.find(p => p.name === loggedInUser.name);
        const managedTeamIds = userRole === 'TeamManager' ? loggedInUser.managesTeamIds : userInPersonnel?.teamIds || [];

        const visibleTeams = mockData.teams.filter(t => managedTeamIds.includes(t.id));
        const accessibleGroupIds = new Set();
        visibleTeams.forEach(team => {
          team.accessibleGroupIds.forEach(id => accessibleGroupIds.add(id));
        });
        groupsToRender = mockData.resourceGroups.filter(g => accessibleGroupIds.has(g.id));
      } else {
        groupsToRender = [];
      }
      // --- End of moved logic ---
      const groupStatusCtx = document.getElementById('groupStatusChart').getContext('2d');

      // 1. Prepare data
      const labels = groupsToRender.map(g => g.name);
      const statuses = { normal: [], warning: [], error: [] };

      groupsToRender.forEach(group => {
        const counts = { normal: 0, warning: 0, error: 0 };
        group.memberIds.forEach(resourceId => {
          const resource = mockData.resources.find(d => d.id === resourceId);
          if (resource) {
            counts[resource.status]++;
          }
        });
        statuses.normal.push(counts.normal);
        statuses.warning.push(counts.warning);
        statuses.error.push(counts.error);
      });

      // 2. Destroy old chart if it exists
      if (groupStatusChartInstance) {
        groupStatusChartInstance.destroy();
      }

      // 3. Create new chart
      groupStatusChartInstance = new Chart(groupStatusCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: '正常',
              data: statuses.normal,
              backgroundColor: '#10b981',
            },
            {
              label: '警告',
              data: statuses.warning,
              backgroundColor: '#f59e0b',
            },
            {
              label: '異常',
              data: statuses.error,
              backgroundColor: '#ef4444',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          },
          plugins: {
            tooltip: {
              mode: 'index',
            }
          }
        }
      });
    }

    function renderUI() {
      if (!loggedInUser) return;

      // Update user info in sidebar
      document.getElementById('user-avatar').src = `https://placehold.co/100x100/64748b/ffffff?text=${loggedInUser.avatar}`;
      document.getElementById('user-name').textContent = loggedInUser.name;
      document.getElementById('user-dept').textContent = loggedInUser.dept;

      showPage('dashboard');
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      document.querySelector('.sidebar-link[data-page="dashboard"]').classList.add('active');
      document.getElementById('breadcrumb').textContent = '總覽儀表板';

      populateDashboard();
      populateTables();
      initializeGeminiFeatures();
      initializeActionModals();
      initializeIncidentManagement();
      populateSettings();
      // NEW: Populate profile page and initialize its actions
      populateProfilePage();
      initializeProfileTabs();
      initializeProfileActions();
      initializeSettingsTabs();
      // NEW: Initialize advanced features
      initializeBatchOperations();
      initializeAutomationFeatures();
      initializeCapacityPlanning();
      renderGroupStatusChart();
    }

    // --- Data Population Functions ---
    function updateTrend(trendId, percentage) {
      const trendEl = document.getElementById(trendId);
      if (!trendEl) return;

      const percentEl = trendEl.querySelector('span.text-sm');
      const svgEl = trendEl.querySelector('svg');

      if (!percentEl || !svgEl) return;

      const isPositive = percentage >= 0;
      const color = isPositive ? 'red' : 'green';
      const sign = isPositive ? '+' : '';

      percentEl.textContent = `${sign}${percentage}%`;
      percentEl.className = `text-sm font-semibold text-${color}-600`;
      svgEl.className = `w-4 h-4 ml-1 text-${color}-600`;

      // Update SVG path for up/down arrow
      if (isPositive) {
        svgEl.innerHTML = `<path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>`;
      } else {
        svgEl.innerHTML = `<path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>`;
      }
    }
    function populateDashboard() {
      const pendingAlerts = getPendingAlerts();
      const notificationList = document.getElementById('notification-list');

      document.getElementById('notification-badge').textContent = pendingAlerts.length;

      document.getElementById('dashboard-new-alerts').textContent = mockData.logs.filter(l => l.status === 'new').length;
      document.getElementById('dashboard-ack-alerts').textContent = mockData.logs.filter(l => l.status === 'ack').length;
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('dashboard-resolved-alerts').textContent = mockData.logs.filter(l => l.status === 'resolved').length; // Simplified for demo

      // Add dynamic trend data
      updateTrend('new-alerts-trend', (Math.random() * 30 - 5).toFixed(0)); // Random % between -5 and 25
      updateTrend('ack-alerts-trend', (Math.random() * 20 - 10).toFixed(0)); // Random % between -10 and 10
      updateTrend('resolved-alerts-trend', (Math.random() * 40 - 5).toFixed(0)); // Random % between -5 and 35

      notificationList.innerHTML = '';
      pendingAlerts.forEach(alert => {
        const dotColor = alert.level === 'error' ? 'bg-red-500' : 'bg-yellow-500';
        const itemHtml = `
                    <a href="#" class="flex items-start px-4 py-3 hover:bg-slate-50">
                        <div class="flex-shrink-0 pt-1">
                            <span class="h-3 w-3 rounded-full ${dotColor} inline-block"></span>
                        </div>
                        <div class="ml-3 w-0 flex-1">
                            <p class="text-sm font-medium text-slate-900">${alert.branch} ${alert.name}</p>
                            <p class="text-sm text-slate-500">${alert.desc}</p>
                        </div>
                    </a>`;
        notificationList.innerHTML += itemHtml;
      });

    }

    function populateTables() {
      const userRole = loggedInUser.role;

      // --- Filter data based on role ---
      let visibleTeams = mockData.teams;
      let visiblePersonnel = mockData.personnel;
      let visibleGroups = mockData.resourceGroups;
      let visibleRules = mockData.alertRules;
      let visibleLogs = mockData.logs;

      const isSuperAdmin = userRole === 'SuperAdmin';

      if (userRole === 'TeamManager' || userRole === 'TeamMember') {
        const managedTeamIds = userRole === 'TeamManager' ? loggedInUser.managesTeamIds : mockData.personnel.find(p => p.name === loggedInUser.name)?.teamIds || [];
        visibleTeams = mockData.teams.filter(t => managedTeamIds.includes(t.id));

        const memberIdsInManagedTeams = new Set();
        mockData.personnel.forEach(p => {
          if (p.teamIds.some(tid => managedTeamIds.includes(tid))) {
            memberIdsInManagedTeams.add(p.id);
          }
        });
        visiblePersonnel = mockData.personnel.filter(p => memberIdsInManagedTeams.has(p.id));

        const accessibleGroupIds = new Set();
        visibleTeams.forEach(team => {
          team.accessibleGroupIds.forEach(id => accessibleGroupIds.add(id));
        });
        visibleGroups = mockData.resourceGroups.filter(g => accessibleGroupIds.has(g.id));

        const accessibleGroupNames = new Set(visibleGroups.map(g => g.name));
        visibleRules = mockData.alertRules.filter(rule => {
          return Array.from(accessibleGroupNames).some(name => rule.target.includes(name));
        });
      }

      // --- Conditionally show/hide UI elements ---
      document.querySelectorAll('[data-admin-only]').forEach(el => el.style.display = isSuperAdmin ? '' : 'none');
      document.querySelectorAll('[data-manager-only]').forEach(el => el.style.display = (isSuperAdmin || userRole === 'TeamManager') ? '' : 'none');

      const addButtons = {
        'add-team-btn': isSuperAdmin, 'add-user-btn': isSuperAdmin, 'add-group-btn': isSuperAdmin,
        'add-channel-btn': isSuperAdmin, 'add-maintenance-btn': (isSuperAdmin || userRole === 'TeamManager'),
        'add-rule-btn': (isSuperAdmin || userRole === 'TeamManager'), 'add-resource-btn': isSuperAdmin
      };
      for (const [id, show] of Object.entries(addButtons)) {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = show ? 'block' : 'none';
      }

      document.querySelector('.sidebar-link[data-page="teams"]').style.display = (isSuperAdmin || userRole === 'TeamManager') ? 'flex' : 'none';
      document.querySelector('.sidebar-link[data-page="personnel"]').style.display = (isSuperAdmin || userRole === 'TeamManager') ? 'flex' : 'none';
      document.querySelector('.sidebar-link[data-page="channels"]').style.display = isSuperAdmin ? 'flex' : 'none';
      document.querySelector('.sidebar-link[data-page="settings"]').style.display = isSuperAdmin ? 'flex' : 'none';

      // Resources Table with Pagination
      let visibleResources = mockData.resources;
      if (!isSuperAdmin) {
        const accessibleGroupIds = new Set();
        visibleTeams.forEach(team => {
          team.accessibleGroupIds.forEach(id => accessibleGroupIds.add(id));
        });
        visibleResources = mockData.resources.filter(resource =>
          resource.groupIds.some(gid => accessibleGroupIds.has(gid))
        );
      }
      const resourcesBody = document.getElementById('resources-table-body');
      resourcesBody.innerHTML = ''; // Clear previous
      visibleResources.forEach((r, index) => {
        const statusDot = r.status === 'normal' ? 'bg-green-500' : (r.status === 'warning' ? 'bg-yellow-500' : 'bg-red-500');
        const groups = r.groupIds.map(gid => mockData.resourceGroups.find(g => g.id === gid)?.name).filter(Boolean);
        const groupsHtml = groups.map(g => `<span class="bg-slate-100 text-slate-600 text-xs font-medium px-2 py-1 rounded-full">${g}</span>`).join(' ');

        const row = `<tr class="bg-white" data-index="${index}">
                        <td data-label="選取" class="px-2 py-4"><input type="checkbox" class="resource-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600" data-resource-id="${r.id}"></td>
                        <td data-label="狀態" class="px-6 py-4"><span class="h-3 w-3 rounded-full inline-block ${statusDot}"></span></td>
                        <td data-label="資源名稱" class="px-6 py-4 font-medium text-slate-900">${r.name}</td>
                        <td data-label="IP 位址" class="px-6 py-4">${r.ip}</td>
                        <td data-label="所屬群組" class="px-6 py-4"><div class="flex flex-wrap gap-1">${groupsHtml || '無'}</div></td>
                        <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                            <button class="edit-resource-btn text-blue-600 hover:text-blue-800 font-medium" style="display: ${userRole === 'TeamMember' ? 'none' : 'inline-block'}">編輯</button>
                            <button class="delete-resource-btn text-red-600 hover:text-red-800 font-medium ml-4" style="display: ${isSuperAdmin ? 'inline-block' : 'none'}">刪除</button>
                        </td></tr>`;
        resourcesBody.innerHTML += row;
      });


      // Populate Resource Groups Table
      const groupsBody = document.getElementById('groups-table-body');
      groupsBody.innerHTML = '';
      visibleGroups.forEach((g) => {
        const index = mockData.resourceGroups.indexOf(g);
        const row = `<tr class="bg-white" data-index="${index}">
                        <td data-label="群組名稱" class="px-6 py-4 font-medium text-slate-900">${g.name}</td>
                        <td data-label="資源數量" class="px-6 py-4">${g.memberIds.length}</td>
                        <td data-label="說明" class="px-6 py-4">${g.description}</td>
                        <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                            <button class="edit-group-btn text-blue-600 hover:text-blue-800 font-medium" style="display: ${userRole === 'TeamMember' ? 'none' : 'inline-block'}">編輯</button>
                            <button class="delete-group-btn text-red-600 hover:text-red-800 font-medium ml-4" style="display: ${isSuperAdmin ? 'inline-block' : 'none'}">刪除</button>
                        </td></tr>`;
        groupsBody.innerHTML += row;
      });

      // Populate Alert Rules Table
      const rulesBody = document.getElementById('rules-table-body');
      rulesBody.innerHTML = '';
      visibleRules.forEach((r) => {
        const index = mockData.alertRules.indexOf(r);
        let statusBadge;
        if (r.silencedUntil) {
          statusBadge = `<span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">靜默中</span>`;
        } else {
          statusBadge = r.enabled ? '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">啟用中</span>' : '<span class="bg-slate-100 text-slate-800 text-xs font-medium px-2.5 py-0.5 rounded-full">已停用</span>';
        }
        const row = `<tr class="bg-white" data-index="${index}">
                        <td data-label="規則名稱" class="px-6 py-4 font-medium text-slate-900">${r.name}</td>
                        <td data-label="監控目標" class="px-6 py-4">${r.target}</td>
                        <td data-label="指標" class="px-6 py-4">${r.metric}</td>
                        <td data-label="啟用狀態" class="px-6 py-4">${statusBadge}</td>
                        <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                            <button class="edit-rule-btn text-blue-600 hover:text-blue-800 font-medium" style="display: ${userRole === 'TeamMember' ? 'none' : 'inline-block'}">編輯</button>
                            <button class="silence-rule-btn text-slate-500 hover:text-slate-800 font-medium ml-4" style="display: ${userRole === 'TeamMember' ? 'none' : 'inline-block'}">靜默</button>
                            <button class="delete-rule-btn text-red-600 hover:text-red-800 font-medium ml-4" style="display: ${isSuperAdmin ? 'inline-block' : 'none'}">刪除</button>
                        </td></tr>`;
        rulesBody.innerHTML += row;
      });

      // Populate Teams Table
      const teamsBody = document.getElementById('teams-table-body');
      teamsBody.innerHTML = '';
      visibleTeams.forEach((t) => {
        const index = mockData.teams.indexOf(t);
        const manager = mockData.personnel.find(p => p.id === t.managerId);
        const managerName = manager ? manager.name : '<span class="text-slate-400">未指派</span>';
        const memberCount = mockData.personnel.filter(p => p.teamIds.includes(t.id)).length;
        const subscribersHtml = t.subscribers.map(s => {
          if (s.type === 'personnel') {
            const user = mockData.personnel.find(p => p.id === s.id);
            return user ? `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${user.name}</span>` : '';
          } else if (s.type === 'channel') {
            const channel = mockData.notificationChannels.find(c => c.id === s.id);
            return channel ? `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2 py-1 rounded-full flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M4.1 11.6a2.4 2.4 0 0 1 0 3.8 2.4 2.4 0 0 1-3.8 0L.3 11.6a2.4 2.4 0 0 1 0-3.8 2.4 2.4 0 0 1 3.8 0Z"/><path d="M12.2 3.5a2.4 2.4 0 0 1 0 3.8 2.4 2.4 0 0 1-3.8 0L8.4 3.5a2.4 2.4 0 0 1 0-3.8 2.4 2.4 0 0 1 3.8 0Z"/><path d="M20.4 19.8a2.4 2.4 0 0 1 0 3.8 2.4 2.4 0 0 1-3.8 0l-3.8-3.8a2.4 2.4 0 0 1 0-3.8 2.4 2.4 0 0 1 3.8 0Z"/><path d="M15.6 8.4a2.4 2.4 0 0 1 0 3.8 2.4 2.4 0 0 1-3.8 0L8.4 8.8a2.4 2.4 0 0 1 0-3.8 2.4 2.4 0 0 1 3.8 0Z"/><path d="m9 15-.8.8"/><path d="m14.2 9.8-.8.8"/></svg>${channel.name}</span>` : '';
          }
        }).filter(Boolean).join(' ');

        const row = `<tr class="bg-white" data-index="${index}">
                        <td data-label="團隊名稱" class="px-6 py-4 font-medium text-slate-900">${t.name}</td>
                        <td data-label="團隊管理員" class="px-6 py-4">${managerName}</td>
                        <td data-label="成員數量" class="px-6 py-4">${memberCount}</td>
                        <td data-label="通知訂閱者" class="px-6 py-4"><div class="flex flex-wrap gap-1">${subscribersHtml || '無'}</div></td>
                        <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                            <button class="edit-team-btn text-blue-600 hover:text-blue-800 font-medium">編輯</button>
                            <button class="delete-team-btn text-red-600 hover:text-red-800 font-medium ml-4" style="display: ${isSuperAdmin ? 'inline-block' : 'none'}">刪除</button>
                        </td></tr>`;
        teamsBody.innerHTML += row;
      });

      // Populate Personnel Table
      const personnelBody = document.getElementById('personnel-table-body');
      personnelBody.innerHTML = '';
      visiblePersonnel.forEach((p) => {
        const index = mockData.personnel.indexOf(p);
        let roleBadge;
        switch (p.role) {
          case 'SuperAdmin':
            roleBadge = '<span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">超級管理員</span>';
            break;
          case 'TeamManager':
            roleBadge = '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">團隊管理員</span>';
            break;
          default:
            roleBadge = '<span class="bg-slate-100 text-slate-800 text-xs font-medium px-2.5 py-0.5 rounded-full">一般使用者</span>';
        }
        const teamsHtml = p.teamIds
          .map(tid => mockData.teams.find(t => t.id === tid)?.name)
          .filter(Boolean)
          .map(tName => `<span class="bg-slate-100 text-slate-600 text-xs font-medium px-2 py-1 rounded-full">${tName}</span>`)
          .join(' ');

        const levelsHtml = `<div class="flex items-center justify-start md:justify-center gap-1">
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${p.subscribedLevels.includes('high') ? 'bg-red-100 text-red-800' : 'bg-slate-100 text-slate-400'}">高</span>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${p.subscribedLevels.includes('medium') ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-400'}">中</span>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${p.subscribedLevels.includes('low') ? 'bg-blue-100 text-blue-800' : 'bg-slate-100 text-slate-400'}">低</span>
                    </div>`;
        const row = `<tr class="bg-white" data-index="${index}">
                        <td data-label="姓名" class="px-6 py-4 font-medium text-slate-900">${p.name}</td>
                        <td data-label="角色" class="px-6 py-4">${roleBadge}</td>
                        <td data-label="所屬團隊" class="px-6 py-4"><div class="flex flex-wrap gap-1">${teamsHtml || '無'}</div></td>
                        <td data-label="接收等級" class="px-6 py-4">${levelsHtml}</td>
                        <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                            <button class="edit-user-btn text-blue-600 hover:text-blue-800 font-medium">編輯</button>
                            <button class="delete-user-btn text-red-600 hover:text-red-800 font-medium ml-4" style="display: ${isSuperAdmin ? 'inline-block' : 'none'}">刪除</button>
                        </td></tr>`;
        personnelBody.innerHTML += row;
      });

      // Populate Maintenance Table
      const maintenanceBody = document.getElementById('maintenance-table-body');
      maintenanceBody.innerHTML = '';
      mockData.maintenance.forEach((m, index) => {
        const groupsHtml = m.groups.map(g => `<span class="bg-slate-100 text-slate-600 text-xs font-medium px-2 py-1 rounded-full">${g}</span>`).join(' ');
        const statusBadge = `<span class="bg-sky-100 text-sky-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${m.status}</span>`;
        const row = `<tr class="bg-white" data-index="${index}">
                        <td data-label="說明" class="px-6 py-4 font-medium text-slate-900">${m.name}</td>
                        <td data-label="影響群組" class="px-6 py-4"><div class="flex flex-wrap gap-1">${groupsHtml}</div></td>
                        <td data-label="開始時間" class="px-6 py-4">${m.start}</td>
                        <td data-label="結束時間" class="px-6 py-4">${m.end}</td>
                        <td data-label="狀態" class="px-6 py-4">${statusBadge}</td>
                        <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                            <button class="edit-maintenance-btn text-blue-600 hover:text-blue-800 font-medium" style="display: ${userRole === 'TeamMember' ? 'none' : 'inline-block'}">編輯</button>
                            <button class="delete-maintenance-btn text-red-600 hover:text-red-800 font-medium ml-4" style="display: ${isSuperAdmin ? 'inline-block' : 'none'}">刪除</button>
                        </td></tr>`;
        maintenanceBody.innerHTML += row;
      });

      // Populate Notification Channels Table
      const channelsBody = document.getElementById('channels-table-body');
      channelsBody.innerHTML = '';
      mockData.notificationChannels.forEach((c, index) => {
        const typeBadge = c.type === 'webhook' ? '<span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Webhook</span>' : '<span class="bg-sky-100 text-sky-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Email</span>';
        const row = `<tr class="bg-white" data-index="${index}">
                        <td data-label="管道名稱" class="px-6 py-4 font-medium text-slate-900">${c.name}</td>
                        <td data-label="管道類型" class="px-6 py-4">${typeBadge}</td>
                        <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                            <button class="test-channel-btn text-green-600 hover:text-green-800 font-medium">測試</button>
                            <button class="edit-channel-btn text-blue-600 hover:text-blue-800 font-medium ml-4">編輯</button>
                            <button class="delete-channel-btn text-red-600 hover:text-red-800 font-medium ml-4">刪除</button>
                        </td></tr>`;
        channelsBody.innerHTML += row;
      });


      // Logs Table
      const logsBody = document.getElementById('logs-table-body');
      logsBody.innerHTML = '';
      mockData.logs.forEach((l, index) => {
        let levelBadge;
        if (l.level === 'error') levelBadge = '<span class="bg-red-100 text-red-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">高</span>';
        else if (l.level === 'warning') levelBadge = '<span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">中</span>';
        else levelBadge = '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">低</span>';

        const statusMap = {
          'new': '<span class="text-red-600 font-semibold">新告警</span>',
          'ack': '<span class="text-yellow-600 font-semibold">處理中</span>',
          'resolved': '<span class="text-green-600 font-semibold">已解決</span>'
        };

        const row = `<tr class="bg-white cursor-pointer hover:bg-slate-50 log-row" data-index="${index}">
                        <td data-label="選取" class="px-2 py-4"><input type="checkbox" class="log-checkbox" data-index="${index}" onclick="event.stopPropagation()"></td>
                        <td data-label="等級" class="px-6 py-4">${levelBadge}</td>
                        <td data-label="時間" class="px-6 py-4">${l.time}</td>
                        <td data-label="狀態" class="px-6 py-4">${statusMap[l.status]}</td>
                        <td data-label="資源名稱" class="px-6 py-4 font-medium text-slate-900">${l.name}</td>
                        <td data-label="處理人員" class="px-6 py-4">${l.assignee || '-'}</td>
                        <td data-label="說明" class="px-6 py-4">${l.desc}</td>
                        <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                             <button class="ack-log-btn text-yellow-600 hover:text-yellow-800 font-medium ${l.status !== 'new' ? 'hidden' : ''}" data-index="${index}">Ack</button>
                        </td></tr>`;
        logsBody.innerHTML += row;
      });

      // Populate Automation Scripts Table
      const scriptsBody = document.getElementById('scripts-table-body');
      if (scriptsBody) {
        scriptsBody.innerHTML = '';
        mockData.automationScripts.forEach((script, index) => {
          const typeBadge = script.type === 'Shell Script' ? '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Shell Script</span>' :
            script.type === 'Ansible Playbook' ? '<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Ansible Playbook</span>' :
              '<span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Python Script</span>';
          const row = `<tr class="bg-white" data-index="${index}">
                          <td data-label="腳本名稱" class="px-6 py-4 font-medium text-slate-900">${script.name}</td>
                          <td data-label="類型" class="px-6 py-4">${typeBadge}</td>
                          <td data-label="描述" class="px-6 py-4">${script.description}</td>
                          <td data-label="最後更新" class="px-6 py-4">${script.lastUpdated}</td>
                          <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                              <button class="test-script-btn text-green-600 hover:text-green-800 font-medium">測試</button>
                              <button class="edit-script-btn text-blue-600 hover:text-blue-800 font-medium ml-4" style="display: ${userRole === 'TeamMember' ? 'none' : 'inline-block'}">編輯</button>
                              <button class="delete-script-btn text-red-600 hover:text-red-800 font-medium ml-4" style="display: ${isSuperAdmin ? 'inline-block' : 'none'}">刪除</button>
                          </td></tr>`;
          scriptsBody.innerHTML += row;
        });
      }

      // Populate Execution Logs Table
      const executionLogsBody = document.getElementById('execution-logs-table-body');
      if (executionLogsBody) {
        executionLogsBody.innerHTML = '';
        mockData.executionLogs.forEach((log, index) => {
          const statusBadge = log.status === 'success' ? '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">成功</span>' :
            '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">失敗</span>';
          const row = `<tr class="bg-white" data-index="${index}">
                          <td data-label="執行時間" class="px-6 py-4">${log.executionTime}</td>
                          <td data-label="腳本名稱" class="px-6 py-4 font-medium text-slate-900">${log.scriptName}</td>
                          <td data-label="觸發告警" class="px-6 py-4">${log.triggerAlert}</td>
                          <td data-label="執行狀態" class="px-6 py-4">${statusBadge}</td>
                          <td data-label="執行時長" class="px-6 py-4">${log.duration}</td>
                          <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                              <button class="view-output-btn text-blue-600 hover:text-blue-800 font-medium">查看輸出</button>
                          </td></tr>`;
          executionLogsBody.innerHTML += row;
        });
      }

      // Update Capacity Planning Dropdowns
      updateCapacityDropdowns();

      return visibleGroups;
    }

    // --- Action Modals & Interactivity ---
    function initializeActionModals() {
      const formModal = document.getElementById('form-modal');
      const formModalTitle = document.getElementById('form-modal-title');
      const formModalBody = document.getElementById('form-modal-body');
      const formModalSaveBtn = document.getElementById('form-modal-save-btn');
      const confirmModal = document.getElementById('confirm-modal');

      let currentEditIndex = null;
      let currentAction = null;

      function openFormModal(title, bodyHtml, action, index = null) {
        console.log(`Opening modal: ${title}`);
        formModalTitle.textContent = title;
        formModalBody.innerHTML = bodyHtml;
        currentAction = action;
        currentEditIndex = index;
        formModal.classList.remove('hidden', 'opacity-0');
        formModal.classList.add('flex');
        formModal.querySelector('div').classList.remove('scale-95');
        // Populate automation script options if the select exists
        const scriptSelect = document.getElementById('automation-script-select');
        if (scriptSelect && scriptSelect.children.length === 1) {
          mockData.automationScripts.forEach(script => {
            scriptSelect.innerHTML += `<option value="${script.id}">${script.name}</option>`;
          });
        }
      }

      function closeFormModal() {
        formModal.querySelector('div').classList.add('scale-95');
        formModal.classList.add('opacity-0');
        setTimeout(() => formModal.classList.add('hidden'), 300);
      }

      window.openConfirmModal = function (text, action, index) {
        document.getElementById('confirm-modal-text').textContent = text;
        const confirmBtn = document.getElementById('confirm-action-btn');
        confirmBtn.className = 'text-white font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2 transition-colors';
        if (action.startsWith('delete')) {
          confirmBtn.classList.add('bg-red-600', 'hover:bg-red-800');
          confirmBtn.textContent = '確定刪除';
        } else {
          confirmBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-800');
          confirmBtn.textContent = '確定';
        }

        currentAction = action;
        currentEditIndex = index;
        confirmModal.classList.remove('hidden', 'opacity-0');
        confirmModal.classList.add('flex');
        setTimeout(() => confirmModal.querySelector('div').classList.remove('scale-95'), 10);
      }

      function closeConfirmModal() {
        confirmModal.querySelector('div').classList.add('scale-95');
        confirmModal.classList.add('opacity-0');
        setTimeout(() => confirmModal.classList.add('hidden'), 300);
      }

      window.showFeedbackModal = function (text) {
        const modal = document.getElementById('feedback-modal');
        document.getElementById('feedback-modal-text').textContent = text;
        modal.classList.remove('hidden', 'opacity-0');
        modal.classList.add('flex');
        const innerDiv = modal.querySelector('div');
        setTimeout(() => innerDiv.classList.remove('scale-95'), 10);
      }

      window.closeFeedbackModal = function () {
        const modal = document.getElementById('feedback-modal');
        const innerDiv = modal.querySelector('div');
        innerDiv.classList.add('scale-95');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
      }


      document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeFormModal));
      document.getElementById('cancel-action-btn').addEventListener('click', closeConfirmModal);

      // Resource Actions
      document.getElementById('add-resource-btn').addEventListener('click', () => {
        console.log("Add resource button clicked!");
        const groupCheckboxes = mockData.resourceGroups.map(g => `<div class="relative flex items-start"><div class="flex h-6 items-center"><input id="group-${g.id}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div><div class="ml-3 text-sm leading-6"><label for="group-${g.id}" class="font-medium text-gray-900">${g.name}</label></div></div>`).join('');
        const formHtml = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">資源名稱</label><input type="text" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">IP 位址</label><input type="text" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">資源群組</legend><div class="space-y-2 mt-2">${groupCheckboxes}</div></fieldset>
                    </div>`;
        openFormModal('新增資源', formHtml, 'add-resource');
      });

      document.getElementById('resources-table-body').addEventListener('click', e => {
        const target = e.target;
        const row = target.closest('tr');
        if (!row) return;
        const index = row.dataset.index;

        if (target.classList.contains('edit-resource-btn')) {
          const resource = mockData.resources[index];
          const groupCheckboxes = mockData.resourceGroups.map(g => {
            const isChecked = resource.groupIds.includes(g.id) ? 'checked' : '';
            return `<div class="relative flex items-start"><div class="flex h-6 items-center"><input id="group-${g.id}" type="checkbox" ${isChecked} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div><div class="ml-3 text-sm leading-6"><label for="group-${g.id}" class="font-medium text-gray-900">${g.name}</label></div></div>`;
          }).join('');
          const formHtml = `
                        <div class="space-y-4">
                            <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">資源名稱</label><input type="text" value="${resource.name}" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                            <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">IP 位址</label><input type="text" value="${resource.ip}" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                            <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">資源群組</legend><div class="space-y-2 mt-2">${groupCheckboxes}</div></fieldset>
                        </div>`;
          openFormModal('編輯資源', formHtml, 'edit-resource', index);
        }
        if (target.classList.contains('delete-resource-btn')) {
          openConfirmModal('您確定要刪除此資源嗎？', 'delete-resource', index);
        }
      });

      // Resource Group Actions
      document.getElementById('add-group-btn').addEventListener('click', () => {
        const resourceCheckboxes = mockData.resources.map(d => `<div class="relative flex items-start"><div class="flex h-6 items-center"><input id="resource-${d.id}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div><div class="ml-3 text-sm leading-6"><label for="resource-${d.id}" class="font-medium text-gray-900">${d.name} (${d.ip})</label></div></div>`).join('');
        const formHtml = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">群組名稱</label><input type="text" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div class="grid grid-cols-3 items-start gap-4"><label class="text-sm font-medium text-slate-700 pt-1">說明</label><textarea rows="3" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea></div>
                        <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">群組資源</legend><div class="space-y-2 mt-2 max-h-40 overflow-y-auto">${resourceCheckboxes}</div></fieldset>
                    </div>`;
        openFormModal('新增群組', formHtml, 'add-group');
      });
      document.getElementById('groups-table-body').addEventListener('click', e => {
        const index = e.target.closest('tr')?.dataset.index;
        if (e.target.classList.contains('edit-group-btn')) {
          const group = mockData.resourceGroups[index];
          const resourceCheckboxes = mockData.resources.map(d => {
            const isChecked = group.memberIds.includes(d.id) ? 'checked' : '';
            return `<div class="relative flex items-start"><div class="flex h-6 items-center"><input id="resource-${d.id}" type="checkbox" ${isChecked} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div><div class="ml-3 text-sm leading-6"><label for="resource-${d.id}" class="font-medium text-gray-900">${d.name} (${d.ip})</label></div></div>`;
          }).join('');
          const formHtml = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">群組名稱</label><input type="text" value="${group.name}" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div class="grid grid-cols-3 items-start gap-4"><label class="text-sm font-medium text-slate-700 pt-1">說明</label><textarea rows="3" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">${group.description}</textarea></div>
                        <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">群組成員</legend><div class="space-y-2 mt-2 max-h-40 overflow-y-auto">${resourceCheckboxes}</div></fieldset>
                    </div>`;
          openFormModal('編輯群組', formHtml, 'edit-group', index);
        }
        if (e.target.classList.contains('delete-group-btn')) openConfirmModal('您確定要刪除此群組嗎？', 'delete-group', index);
      });

      // Alert Rule Actions
      document.getElementById('add-rule-btn').addEventListener('click', () => {
        const groupOptions = mockData.resourceGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
        const formHtml = `
          <div class="max-h-[65vh] overflow-y-auto p-1 pr-2">
            <div class="space-y-2">
                <!-- Accordion Item 1: Basic Settings (Expanded by default) -->
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <div class="accordion-header bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer transition-colors duration-200">
                        <h4 class="font-semibold text-slate-800">基本設定</h4>
                        <svg class="h-5 w-5 text-slate-500 transition-transform duration-300 ease-in-out rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg>
                    </div>
                    <div class="accordion-content p-4 border-t border-slate-200">
                        <div class="space-y-4 text-sm">
                            <div><label class="font-medium text-slate-700">規則名稱</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-1.5"></div>
                            <div class="flex items-center justify-between"><label class="font-medium text-slate-700">啟用規則</label><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div>
                            <div><label class="font-medium text-slate-700">監控目標</label><select class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-1.5"><option>選擇資源群組</option>${groupOptions}</select></div>
                            <div><label class="font-medium text-slate-700">指標</label><select class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-1.5"><option>CPU 使用率</option><option>網路流量</option><option>網路延遲 (Ping)</option></select></div>
                            <fieldset class="mt-4 border-t pt-4"><legend class="font-medium text-slate-700 mb-2">告警條件</legend>
                                <div class="space-y-2" id="alert-conditions">
                                    <div class="grid grid-cols-12 gap-2 items-center">
                                        <span class="col-span-1 text-center">&gt;</span>
                                        <input type="number" placeholder="閾值" class="col-span-3 px-3 py-1.5 border rounded-md">
                                        <span class="col-span-1 text-center">持續</span>
                                        <select class="col-span-3 px-3 py-1.5 border rounded-md"><option>5 分鐘</option><option>10 分鐘</option></select>
                                        <span class="col-span-1 text-center">為</span>
                                        <select class="col-span-3 px-3 py-1.5 border rounded-md"><option value="high">高</option><option value="medium">中</option><option value="low">低</option></select>
                                    </div>
                                </div>
                                <button id="add-condition-btn" type="button" class="mt-2 text-blue-600 text-sm font-semibold hover:underline">+ 新增條件</button>
                            </fieldset>
                        </div>
                    </div>
                </div>

                <!-- Accordion Item 2: Automation (Collapsed by default) -->
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <div class="accordion-header bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer transition-colors duration-200">
                        <h4 class="font-semibold text-slate-800">自動化響應 (選填)</h4>
                        <svg class="h-5 w-5 text-slate-500 transition-transform duration-300 ease-in-out" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg>
                    </div>
                    <div class="accordion-content p-4 border-t border-slate-200 hidden">
                        <div class="space-y-4 text-sm">
                            <div><label class="font-medium text-slate-700">選擇腳本</label>
                                <select id="automation-script-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="">不使用自動化響應</option>
                                </select>
                            </div>
                            <div id="script-parameters" class="hidden">
                                <label class="font-medium text-slate-700">參數映射</label>
                                <div class="mt-2 space-y-2" id="parameter-mappings"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accordion Item 3: Custom Notification (Collapsed by default) -->
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <div class="accordion-header bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer transition-colors duration-200">
                        <h4 class="font-semibold text-slate-800">通知內容自定義 (選填)</h4>
                        <svg class="h-5 w-5 text-slate-500 transition-transform duration-300 ease-in-out" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg>
                    </div>
                    <div class="accordion-content p-4 border-t border-slate-200 hidden">
                         <div class="space-y-2 text-sm">
                            <div><label class="font-medium text-slate-700">自訂標題</label><input type="text" placeholder="[告警] {{ .DeviceName }} 發生問題" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm"></div>
                            <div><label class="font-medium text-slate-700">自訂內容</label><textarea rows="4" placeholder="資源 {{ .DeviceName }} ({{ .DeviceIP }}) 的 {{ .MetricName }} 指標目前數值為 {{ .MetricValue }}，已觸發告警。" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm"></textarea></div>
                            <p class="text-xs text-slate-500 mt-2">如果留空，將使用預設的通知範本。您可以使用變數，如 {{ .DeviceName }}。</p>
                        </div>
                    </div>
                </div>
            </div>
          </div>`;
        openFormModal('新增告警規則', formHtml, 'add-rule');
      });
      document.getElementById('rules-table-body').addEventListener('click', e => {
        const index = e.target.closest('tr')?.dataset.index;
        if (e.target.classList.contains('edit-rule-btn')) {
          const rule = mockData.alertRules[index];
          const groupOptions = mockData.resourceGroups.map(g => `<option value="${g.id}" ${rule.target.includes(g.name) ? 'selected' : ''}>${g.name}</option>`).join('');
          const formHtml = `
            <div class="max-h-[65vh] overflow-y-auto p-1 pr-2">
              <div class="space-y-2">
                  <!-- Accordion Item 1: Basic Settings (Expanded by default) -->
                  <div class="border border-slate-200 rounded-lg overflow-hidden">
                      <div class="accordion-header bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer transition-colors duration-200">
                          <h4 class="font-semibold text-slate-800">基本設定</h4>
                          <svg class="h-5 w-5 text-slate-500 transition-transform duration-300 ease-in-out rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg>
                      </div>
                      <div class="accordion-content p-4 border-t border-slate-200">
                          <div class="space-y-4 text-sm">
                              <div><label class="font-medium text-slate-700">規則名稱</label><input type="text" value="${rule.name}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-1.5"></div>
                              <div class="flex items-center justify-between"><label class="font-medium text-slate-700">啟用規則</label><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" ${rule.enabled ? 'checked' : ''} class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div>
                              <div><label class="font-medium text-slate-700">監控目標</label><select class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-1.5"><option>選擇資源群組</option>${groupOptions}</select></div>
                              <div><label class="font-medium text-slate-700">指標</label><select class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-1.5"><option>CPU 使用率</option><option>網路流量</option><option>網路延遲 (Ping)</option></select></div>
                              <fieldset class="mt-4 border-t pt-4"><legend class="font-medium text-slate-700 mb-2">告警條件</legend>
                                  <div class="space-y-2" id="alert-conditions">
                                      <div class="grid grid-cols-12 gap-2 items-center">
                                          <span class="col-span-1 text-center">&gt;</span>
                                          <input type="number" placeholder="閾值" value="90" class="col-span-3 px-3 py-1.5 border rounded-md">
                                          <span class="col-span-1 text-center">持續</span>
                                          <select class="col-span-3 px-3 py-1.5 border rounded-md"><option>5 分鐘</option><option selected>10 分鐘</option></select>
                                          <span class="col-span-1 text-center">為</span>
                                          <select class="col-span-3 px-3 py-1.5 border rounded-md"><option value="high" selected>高</option><option value="medium">中</option><option value="low">低</option></select>
                                      </div>
                                  </div>
                                  <button id="add-condition-btn" type="button" class="mt-2 text-blue-600 text-sm font-semibold hover:underline">+ 新增條件</button>
                              </fieldset>
                          </div>
                      </div>
                  </div>

                  <!-- Accordion Item 2: Automation (Collapsed by default) -->
                  <div class="border border-slate-200 rounded-lg overflow-hidden">
                      <div class="accordion-header bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer transition-colors duration-200">
                          <h4 class="font-semibold text-slate-800">自動化響應 (選填)</h4>
                          <svg class="h-5 w-5 text-slate-500 transition-transform duration-300 ease-in-out" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg>
                      </div>
                      <div class="accordion-content p-4 border-t border-slate-200 hidden">
                          <div class="space-y-4 text-sm">
                              <div><label class="font-medium text-slate-700">選擇腳本</label>
                                  <select id="automation-script-select" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                      <option value="">不使用自動化響應</option>
                                  </select>
                              </div>
                              <div id="script-parameters" class="hidden">
                                  <label class="font-medium text-slate-700">參數映射</label>
                                  <div class="mt-2 space-y-2" id="parameter-mappings"></div>
                              </div>
                          </div>
                      </div>
                  </div>

                  <!-- Accordion Item 3: Custom Notification (Collapsed by default) -->
                  <div class="border border-slate-200 rounded-lg overflow-hidden">
                      <div class="accordion-header bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer transition-colors duration-200">
                          <h4 class="font-semibold text-slate-800">通知內容自定義 (選填)</h4>
                          <svg class="h-5 w-5 text-slate-500 transition-transform duration-300 ease-in-out" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg>
                      </div>
                      <div class="accordion-content p-4 border-t border-slate-200 hidden">
                           <div class="space-y-2 text-sm">
                              <div><label class="font-medium text-slate-700">自訂標題</label><input type="text" placeholder="[告警] {{ .DeviceName }} 發生問題" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm"></div>
                              <div><label class="font-medium text-slate-700">自訂內容</label><textarea rows="4" placeholder="資源 {{ .DeviceName }} ({{ .DeviceIP }}) 的 {{ .MetricName }} 指標目前數值為 {{ .MetricValue }}，已觸發告警。" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm"></textarea></div>
                              <p class="text-xs text-slate-500 mt-2">如果留空，將使用預設的通知範本。您可以使用變數，如 {{ .DeviceName }}。</p>
                          </div>
                      </div>
                  </div>
              </div>
            </div>`;
          openFormModal('編輯告警規則', formHtml, 'edit-rule', index);
        }
        if (e.target.classList.contains('delete-rule-btn')) openConfirmModal('您確定要刪除此規則嗎？', 'delete-rule', index);
        if (e.target.classList.contains('silence-rule-btn')) openFormModal('靜默告警規則', `<div class="space-y-2"><label class="text-sm font-medium text-slate-700">靜默時間</label><select class="mt-1 block w-full rounded-md border-slate-300 shadow-sm"><option>1 小時</option><option>2 小時</option><option>8 小時</option><option>24 小時</option></select></div>`, 'silence-rule');
      });
      document.getElementById('form-modal-body').addEventListener('click', e => {
        if (e.target.id === 'add-condition-btn') {
          const container = document.getElementById('alert-conditions');
          const newCondition = container.firstElementChild.cloneNode(true);
          newCondition.querySelectorAll('input, select').forEach(el => el.value = '');
          container.appendChild(newCondition);
        }
      });

      // Handle accordion toggle
      document.getElementById('form-modal-body').addEventListener('click', e => {
        const header = e.target.closest('.accordion-header');
        if (!header) return;

        const content = header.nextElementSibling;
        const icon = header.querySelector('svg');

        if (content && content.classList.contains('accordion-content')) {
          content.classList.toggle('hidden');
          icon.classList.toggle('rotate-180');
        }
      });

      // Handle automation script selection
      document.getElementById('form-modal-body').addEventListener('change', e => {
        if (e.target.id === 'automation-script-select') {
          const scriptId = e.target.value;
          const parametersDiv = document.getElementById('script-parameters');
          const mappingsDiv = document.getElementById('parameter-mappings');

          if (scriptId) {
            const script = mockData.automationScripts.find(s => s.id == scriptId);
            if (script && script.parameters.length > 0) {
              parametersDiv.classList.remove('hidden');
              mappingsDiv.innerHTML = script.parameters.map(param => `
                <div class="grid grid-cols-3 gap-2 items-center">
                  <label class="text-sm text-slate-600">${param}:</label>
                  <select class="col-span-2 text-sm rounded-md border-slate-300">
                    <option value="instance">資源 IP (instance)</option>
                    <option value="alertname">告警名稱 (alertname)</option>
                    <option value="severity">嚴重程度 (severity)</option>
                    <option value="job">任務名稱 (job)</option>
                  </select>
                </div>
              `).join('');
            } else {
              parametersDiv.classList.add('hidden');
            }
          } else {
            parametersDiv.classList.add('hidden');
          }
        }
      });

      // Team Actions
      document.getElementById('add-team-btn').addEventListener('click', () => {
        const formHtml = `
            <div class="space-y-4">
                <div class="grid grid-cols-3 items-center gap-4">
                    <label for="team-name" class="text-sm font-medium text-slate-700">團隊名稱</label>
                    <input id="team-name" type="text" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm">
                </div>
                <fieldset class="mt-4">
                    <legend class="text-sm font-medium text-slate-700 mb-2">通知訂閱者</legend>
                    <select id="team-subscribers" multiple></select>
                </fieldset>
            </div>`;
        openFormModal('新增團隊', formHtml, 'add-team');
        formModal.tomSelectInstances = {
          subscribers: new TomSelect('#team-subscribers', {
            placeholder: '搜尋人員或通知管道...',
            plugins: ['remove_button'],
            optgroups: [
              { value: 'personnel', label: '人員' },
              { value: 'channels', label: '通知管道' }
            ],
            options: [
              ...mockData.personnel.map(p => ({ value: `personnel-${p.id}`, text: p.name, optgroup: 'personnel' })),
              ...mockData.notificationChannels.map(c => ({ value: `channel-${c.id}`, text: c.name, optgroup: 'channels' }))
            ]
          })
        };
      });

      document.getElementById('teams-table-body').addEventListener('click', e => {
        const index = e.target.closest('tr')?.dataset.index;
        if (e.target.classList.contains('edit-team-btn')) {
          const team = mockData.teams[index];
          const formHtml = `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 items-center gap-4">
                        <label for="team-name" class="text-sm font-medium text-slate-700">團隊名稱</label>
                        <input id="team-name" type="text" value="${team.name}" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm">
                    </div>
                    <fieldset class="mt-4">
                        <legend class="text-sm font-medium text-slate-700 mb-2">通知訂閱者</legend>
                        <select id="team-subscribers" multiple></select>
                    </fieldset>
                </div>`;
          openFormModal('編輯團隊', formHtml, 'edit-team', index);

          const selectedItems = team.subscribers.map(s => `${s.type}-${s.id}`);
          formModal.tomSelectInstances = {
            subscribers: new TomSelect('#team-subscribers', {
              placeholder: '搜尋人員或通知管道...',
              plugins: ['remove_button'],
              optgroups: [
                { value: 'personnel', label: '人員' },
                { value: 'channels', label: '通知管道' }
              ],
              options: [
                ...mockData.personnel.map(p => ({ value: `personnel-${p.id}`, text: p.name, optgroup: 'personnel' })),
                ...mockData.notificationChannels.map(c => ({ value: `channel-${c.id}`, text: c.name, optgroup: 'channels' }))
              ],
              items: selectedItems
            })
          };
        }
        if (e.target.classList.contains('delete-team-btn')) openConfirmModal('您確定要刪除此團隊嗎？', 'delete-team', index);
      });

      // Maintenance Actions
      document.getElementById('add-maintenance-btn').addEventListener('click', () => {
        const groupCheckboxes = mockData.resourceGroups.map(g => `<div class="relative flex items-start"><div class="flex h-6 items-center"><input id="maint-group-${g.id}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div><div class="ml-3 text-sm leading-6"><label for="maint-group-${g.id}" class="font-medium text-gray-900">${g.name}</label></div></div>`).join('');
        const formHtml = `
                    <div class="space-y-4">
                        <div><label class="text-sm font-medium text-slate-700">說明</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="text-sm font-medium text-slate-700">開始時間</label><input type="datetime-local" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="text-sm font-medium text-slate-700">結束時間</label><input type="datetime-local" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">影響資源群組</legend><div class="space-y-2 mt-2">${groupCheckboxes}</div></fieldset>
                    </div>`;
        openFormModal('新增維護時段', formHtml, 'add-maintenance');
      });
      document.getElementById('maintenance-table-body').addEventListener('click', e => {
        const index = e.target.closest('tr')?.dataset.index;
        if (e.target.classList.contains('edit-maintenance-btn')) {
          const maint = mockData.maintenance[index];
          const groupCheckboxes = mockData.resourceGroups.map(g => {
            const isChecked = maint.groups.includes(g.name) ? 'checked' : '';
            return `<div class="relative flex items-start"><div class="flex h-6 items-center"><input id="maint-group-${g.id}" type="checkbox" ${isChecked} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div><div class="ml-3 text-sm leading-6"><label for="maint-group-${g.id}" class="font-medium text-gray-900">${g.name}</label></div></div>`;
          }).join('');
          const formHtml = `
                    <div class="space-y-4">
                        <div><label class="text-sm font-medium text-slate-700">說明</label><input type="text" value="${maint.name}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="text-sm font-medium text-slate-700">開始時間</label><input type="datetime-local" value="${new Date(maint.start).toISOString().slice(0, 16)}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="text-sm font-medium text-slate-700">結束時間</label><input type="datetime-local" value="${new Date(maint.end).toISOString().slice(0, 16)}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">影響資源群組</legend><div class="space-y-2 mt-2">${groupCheckboxes}</div></fieldset>
                    </div>`;
          openFormModal('編輯維護時段', formHtml, 'edit-maintenance', index);
        }
        if (e.target.classList.contains('delete-maintenance-btn')) openConfirmModal('您確定要刪除此維護時段嗎？', 'delete-maintenance', index);
      });


      // User/Personnel Actions
      document.getElementById('add-user-btn').addEventListener('click', () => {
        const formHtml = `
                    <div class="space-y-4">
                        <p class="text-sm text-slate-500 mb-4 -mt-2">僅供組織權限管理，個人通知設定請至「個人資料」頁面。</p>
                        <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">姓名</label><input id="user-name" type="text" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">角色</label>
                          <select id="user-role" class="col-span-2 mt-1 block w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 focus:border-blue-500 focus:ring-blue-500">
                            <option value="SuperAdmin">超級管理員</option>
                            <option value="TeamManager">團隊管理員</option>
                            <option value="TeamMember">一般使用者</option>
                          </select>
                        </div>
                        <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">團隊歸屬</legend><select id="user-teams" multiple></select></fieldset>
                    </div>`;
        openFormModal('新增人員', formHtml, 'add-user');
        formModal.tomSelectInstances = {
          teams: new TomSelect('#user-teams', {
            options: mockData.teams.map(t => ({ value: t.id, text: t.name })),
            placeholder: '搜尋團隊...',
            plugins: ['remove_button'],
          })
        };
      });

      document.getElementById('personnel-table-body').addEventListener('click', e => {
        const target = e.target;
        const row = target.closest('tr');
        if (!row) return;
        const index = row.dataset.index;

        if (target.classList.contains('edit-user-btn')) {
          const user = mockData.personnel[index];
          const formHtml = `
                        <div class="space-y-4">
                            <p class="text-sm text-slate-500 mb-4 -mt-2">僅供組織權限管理，個人通知設定請至「個人資料」頁面。</p>
                            <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">姓名</label><input id="user-name" type="text" value="${user.name}" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm"></div>
                             <div class="grid grid-cols-3 items-center gap-4"><label class="text-sm font-medium text-slate-700">角色</label>
                              <select id="user-role" class="col-span-2 mt-1 block w-full rounded-md border-slate-300 shadow-sm">
                                <option value="SuperAdmin" ${user.role === 'SuperAdmin' ? 'selected' : ''}>超級管理員</option>
                                <option value="TeamManager" ${user.role === 'TeamManager' ? 'selected' : ''}>團隊管理員</option>
                                <option value="TeamMember" ${user.role === 'TeamMember' ? 'selected' : ''}>一般使用者</option>
                              </select>
                            </div>
                            <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">團隊歸屬</legend><select id="user-teams" multiple></select></fieldset>
                        </div>`;
          openFormModal('編輯人員', formHtml, 'edit-user', index);
          formModal.tomSelectInstances = {
            teams: new TomSelect('#user-teams', {
              options: mockData.teams.map(t => ({ value: t.id, text: t.name })),
              items: user.teamIds,
              placeholder: '搜尋團隊...',
              plugins: ['remove_button'],
            })
          };
        }
        if (target.classList.contains('delete-user-btn')) {
          openConfirmModal('您確定要刪除此人員嗎？', 'delete-user', index);
        }
      });

      // Notification Channel Actions
      document.getElementById('add-channel-btn').addEventListener('click', () => {
        openChannelFormModal('新增通知管道', 'add-channel');
      });

      document.getElementById('channels-table-body').addEventListener('click', e => {
        const index = e.target.closest('tr')?.dataset.index;
        if (e.target.classList.contains('test-channel-btn')) {
          showFeedbackModal('測試訊息已發送！');
          setTimeout(closeFeedbackModal, 1500);
        }
        if (e.target.classList.contains('delete-channel-btn')) {
          openConfirmModal('您確定要刪除此管道嗎？', 'delete-channel', index);
        }
        if (e.target.classList.contains('edit-channel-btn')) {
          const channel = mockData.notificationChannels[index];
          openChannelFormModal('編輯通知管道', 'edit-channel', index, channel);
        }
      });

      function openChannelFormModal(title, action, index = null, channel = {}) {
        const formHtml = `
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-slate-700">管道名稱</label>
                    <input id="channel-name" type="text" value="${channel.name || ''}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm">
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">管道類型</label>
                <select id="channel-type-select" class="mt-1 block w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 focus:border-blue-500 focus:ring-blue-500">
                        <option value="email" ${channel.type === 'email' ? 'selected' : ''}>Email</option>
                        <option value="webhook" ${channel.type === 'webhook' ? 'selected' : ''}>Webhook (通用)</option>
                        <option value="slack" ${channel.type === 'slack' ? 'selected' : ''}>Slack</option>
                        <option value="line" ${channel.type === 'line' ? 'selected' : ''}>LINE Notify</option>
                        <option value="sms" ${channel.type === 'sms' ? 'selected' : ''}>SMS (簡訊)</option>
                    </select>
                </div>
                <div id="channel-fields-container" class="space-y-4 border-t pt-4 mt-4">
                    <!-- Dynamic fields will be injected here -->
                </div>
            </div>`;

        openFormModal(title, formHtml, action, index);

        const typeSelect = document.getElementById('channel-type-select');
        const fieldsContainer = document.getElementById('channel-fields-container');

        const allFields = {
          email: `
            <div><label class="text-sm font-medium text-slate-700">收件人 (To)</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm" value="${channel.to || ''}"></div>
            <div><label class="text-sm font-medium text-slate-700">副本 (CC)</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm" value="${channel.cc || ''}"></div>
            <div><label class="text-sm font-medium text-slate-700">密件副本 (BCC)</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm" value="${channel.bcc || ''}"></div>
          `,
          webhook: `
            <div><label class="text-sm font-medium text-slate-700">Webhook URL</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm" value="${channel.url || ''}"></div>
            <div><label class="text-sm font-medium text-slate-700">HTTP 方法 (Method)</label>
              <select class="mt-1 block w-full rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-800 focus:border-blue-500 focus:ring-blue-500">
                <option value="POST" ${channel.method === 'POST' ? 'selected' : ''}>POST</option>
                <option value="PUT" ${channel.method === 'PUT' ? 'selected' : ''}>PUT</option>
              </select>
            </div>
          `,
          slack: `
            <div><label class="text-sm font-medium text-slate-700">Incoming Webhook URL</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm" value="${channel.url || ''}"></div>
            <div><label class="text-sm font-medium text-slate-700">提及對象 (Mention)</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm" placeholder="@here, @channel, or user ID" value="${channel.mention || ''}"></div>
          `,
          line: `
            <div><label class="text-sm font-medium text-slate-700">存取權杖 (Access Token)</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm" value="${channel.token || ''}"></div>
          `,
          sms: `
            <div><label class="text-sm font-medium text-slate-700">收件人手機號碼</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm sm:text-sm" placeholder="請輸入手機號碼" value="${channel.recipient || ''}"></div>
          `
        };

        function updateFields() {
          const selectedType = typeSelect.value;
          fieldsContainer.innerHTML = allFields[selectedType] || '';
        }

        typeSelect.addEventListener('change', updateFields);
        updateFields(); // Initial call
      }


      // Save and Delete Logic
      formModalSaveBtn.addEventListener('click', () => {
        if (currentAction === 'add-user') {
          const name = document.getElementById('user-name').value;
          const role = document.getElementById('user-role').value;
          const teamIds = formModal.tomSelectInstances.teams.getValue().map(id => parseInt(id));

          mockData.personnel.push({
            id: mockData.personnel.length > 0 ? Math.max(...mockData.personnel.map(p => p.id)) + 1 : 1,
            name,
            email: '',
            lineToken: '',
            role,
            teamIds,
            subscribedLevels: [],
          });
          showFeedbackModal('人員已新增！');
          setTimeout(closeFeedbackModal, 1500);
        } else if (currentAction === 'edit-user') {
          const user = mockData.personnel[currentEditIndex];
          user.name = document.getElementById('user-name').value;
          user.role = document.getElementById('user-role').value;
          user.teamIds = formModal.tomSelectInstances.teams.getValue().map(id => parseInt(id));
          showFeedbackModal('人員資訊已更新！');
          setTimeout(closeFeedbackModal, 1500);
        } else if (currentAction === 'add-script') {
          const inputs = formModalBody.querySelectorAll('input, textarea, select');
          const newScript = {
            id: mockData.automationScripts.length + 1,
            name: inputs[0].value || '新腳本',
            type: inputs[1].value,
            description: inputs[2].value || '腳本描述',
            lastUpdated: new Date().toISOString().slice(0, 10),
            parameters: inputs[4].value ? inputs[4].value.split(',').map(p => p.trim()) : []
          };
          mockData.automationScripts.push(newScript);
          showFeedbackModal('腳本已新增！');
          setTimeout(closeFeedbackModal, 1500);
        } else if (currentAction === 'edit-script') {
          const inputs = formModalBody.querySelectorAll('input, textarea, select');
          const script = mockData.automationScripts[currentEditIndex];
          script.name = inputs[0].value;
          script.type = inputs[1].value;
          script.description = inputs[2].value;
          script.lastUpdated = new Date().toISOString().slice(0, 10);
          script.parameters = inputs[4].value ? inputs[4].value.split(',').map(p => p.trim()) : [];
          showFeedbackModal('腳本已更新！');
          setTimeout(closeFeedbackModal, 1500);
        } else if (currentAction === 'add-team') {
          const name = document.getElementById('team-name').value;
          const subscribers = formModal.tomSelectInstances.subscribers.getValue().map(val => {
            const [type, id] = val.split('-');
            return { type, id: parseInt(id) };
          });
          mockData.teams.push({
            id: mockData.teams.length > 0 ? Math.max(...mockData.teams.map(t => t.id)) + 1 : 1,
            name,
            subscribers,
            managerId: null,
            accessibleGroupIds: [] // Keep empty as it's deprecated
          });
          showFeedbackModal('團隊已新增！');
          setTimeout(closeFeedbackModal, 1500);
        } else if (currentAction === 'edit-team') {
          const team = mockData.teams[currentEditIndex];
          team.name = document.getElementById('team-name').value;
          team.subscribers = formModal.tomSelectInstances.subscribers.getValue().map(val => {
            const [type, id] = val.split('-');
            return { type, id: parseInt(id) };
          });
          showFeedbackModal('團隊資訊已更新！');
          setTimeout(closeFeedbackModal, 1500);
        } else {
          console.log(`Saving action: ${currentAction} for index: ${currentEditIndex}`);
        }
        closeFormModal();
        populateTables();
      });

      document.getElementById('confirm-action-btn').addEventListener('click', () => {
        if (currentAction.startsWith('delete-')) {
          const type = currentAction.split('-')[1];
          const dataKey = type === 'user' ? 'personnel' : (type === 'channel' ? 'notificationChannels' : type + 's');
          mockData[dataKey]?.splice(currentEditIndex, 1);
        }
        closeConfirmModal();
        populateTables();
        populateDashboard();
      });

      // System Settings Actions
      document.getElementById('save-settings-btn').addEventListener('click', () => {
        mockData.systemSettings.grafanaUrl = document.getElementById('grafana-url').value;
        mockData.systemSettings.smtp.server = document.getElementById('smtp-server').value;
        mockData.systemSettings.smtp.port = document.getElementById('smtp-port').value;
        mockData.systemSettings.smtp.user = document.getElementById('smtp-user').value;
        mockData.systemSettings.smtp.pass = document.getElementById('smtp-pass').value;
        showFeedbackModal('系統設定已儲存！');
        setTimeout(closeFeedbackModal, 1500);
      });
    }

    function populateSettings() {
      document.getElementById('grafana-url').value = mockData.systemSettings.grafanaUrl;
      document.getElementById('smtp-server').value = mockData.systemSettings.smtp.server;
      document.getElementById('smtp-port').value = mockData.systemSettings.smtp.port;
      document.getElementById('smtp-user').value = mockData.systemSettings.smtp.user;
      document.getElementById('smtp-pass').value = mockData.systemSettings.smtp.pass;
    }

    // --- Gemini AI Feature Logic ---
    function initializeGeminiFeatures() {
      const modal = document.getElementById('gemini-modal');
      const modalDialog = modal.querySelector('div');
      const closeModalBtn = document.getElementById('close-gemini-modal');
      const modalContent = document.getElementById('gemini-modal-content');
      const generateReportBtn = document.getElementById('generate-report-btn');
      const copyReportBtn = document.getElementById('copy-report-btn');
      const logsBody = document.getElementById('logs-table-body');
      const selectAllCheckbox = document.getElementById('select-all-logs');

      function openModal() {
        modal.classList.remove('hidden', 'opacity-0');
        modal.classList.add('flex');
        setTimeout(() => modalDialog.classList.remove('scale-95'), 10);
      }
      function closeModal() {
        modalDialog.classList.add('scale-95');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
      }
      closeModalBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

      function updateReportButtonState() {
        const checkedLogs = document.querySelectorAll('.log-checkbox:checked');
        generateReportBtn.disabled = checkedLogs.length === 0;
      }

      selectAllCheckbox.addEventListener('change', (e) => {
        document.querySelectorAll('.log-checkbox').forEach(cb => cb.checked = e.target.checked);
        updateReportButtonState();
      });

      logsBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('log-checkbox')) {
          updateReportButtonState();
          selectAllCheckbox.checked = document.querySelectorAll('.log-checkbox:checked').length === document.querySelectorAll('.log-checkbox').length;
        }
      });

      generateReportBtn.addEventListener('click', handleGenerateReport);

      copyReportBtn.addEventListener('click', () => {
        const reportText = modalContent.innerText;
        navigator.clipboard.writeText(reportText).then(() => {
          copyReportBtn.textContent = '已複製!';
          setTimeout(() => { copyReportBtn.textContent = '複製報告'; }, 2000);
        }).catch(err => console.error('無法複製文字: ', err));
      });

      async function handleGenerateReport() {
        const selectedLogs = Array.from(document.querySelectorAll('.log-checkbox:checked')).map(cb => mockData.logs[cb.dataset.index]);
        if (selectedLogs.length === 0) return;
        const logsString = selectedLogs.map(log => `- 時間: ${log.time}, 分行: ${log.branch}, 資源: ${log.name} (${log.ip}), 等級: ${log.level}, 描述: ${log.desc}`).join('\n');
        const prompt = `你是一位資深的IT部門經理，請根據以下多筆維運系統的告警紀錄，撰寫一份專業、結構化的事件報告(Incident Report)。報告需使用繁體中文，並包含以下段落：\n\n1.  **事件摘要 (Summary):** 簡要說明事件的核心問題、影響範圍。\n2.  **事件時間軸 (Timeline):** 依時序整理關鍵的告警事件。\n3.  **影響評估 (Impact Assessment):** 分析此事件可能對業務造成的影響。\n4.  **根本原因分析 (Root Cause Analysis):** 根據紀錄推測最可能的問題根源。\n5.  **後續處理建議 (Recommended Actions):** 提出具體的解決方案與長期改善建議。\n\n原始告警紀錄如下：\n${logsString}`;
        openModal();
        setModalLoading();
        const result = await callGeminiAPI(prompt);
        setModalContent(result, "事件報告");
      }

      function setModalLoading() {
        modalContent.innerHTML = `<div class="flex flex-col items-center justify-center h-64">
                        <svg class="animate-spin h-10 w-10 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-slate-600 font-semibold">AI 正在分析中，請稍候...</p>
                    </div>`;
      }

      function setModalContent(content, type) {
        let htmlContent = '';
        if (type === "事件報告") {
          htmlContent = content
            .replace(/###\s(.*?)\n/g, '<h3>$1</h3>')
            .replace(/\*\*\s(.*?):/g, '<h4>$1:</h4>')
            .replace(/-\s(.*?)\n/g, '<li>$1</li>')
            .replace(/<li>/g, '<ul><li>')
            .replace(/<\/li>\n<ul>/g, '</li><li>')
            .replace(/<\/li>\n(?!<ul>)/g, '</li></ul>');
        } else {
          htmlContent = content
            .replace(/\*\*(.*?):\*\*/g, '<h4>$1:</h4>')
            .replace(/-\s(.*?)\n/g, '<li>$1</li>')
            .replace(/<li>/g, '<ul><li>')
            .replace(/<\/li>\n<ul>/g, '</li><li>')
            .replace(/<\/li>\n(?!<ul>)/g, '</li></ul>');
        }
        modalContent.innerHTML = `<div class="prose max-w-none">${htmlContent.replace(/<br>/g, '')}</div>`;
      }

      window.callGeminiAPI = async function (prompt, type = "單筆告警分析") {
        await new Promise(resolve => setTimeout(resolve, 1500));
        if (prompt.includes("根本原因推測")) {
          return `**根本原因推測:**\n交換器 (Switch) Edge SW13 可能已完全離線或無法回應網路請求。原因可能包含：\n- 資源斷電或當機。\n- 連接該資源的網路線路中斷 (例如：線路鬆脫、光纖受損)。\n- 上層網路資源 (如 Core Switchitch) 發生問題，導致無法連線至此資源。\n\n**建議處理步驟:**\n1.  **遠端檢查:** 嘗試從跳板機 (Jump Host) SSH 或 Telnet 登入該資源，確認是否能連線。\n2.  **現場檢查:** 若無法遠端連線，請通知分行IT人員或派員至現場，檢查資源電源燈號與網路線路是否正常。\n3.  **關聯性檢查:** 同時檢查仁愛分行其他資源的狀態，確認是否為單一資源問題或區域性網路中斷。`;
        } else if (prompt.includes("事件報告")) {
          return `### 網路事件報告：仁愛分行多重資源斷線事件\n\n**1. 事件摘要:**\n本日上午 10:26 左右，監控系統偵測到仁愛分行兩台核心交換器 (Edge SW13, Edge SW11) 同時發生斷線告警，持續時間超過15分鐘。此事件可能導致該分行內部網路服務全面中斷。\n\n**2. 事件時間軸:**\n- 2025.8.26 10:26: 系統發出告警，資源 Edge SW13 (88.201.0.13) 断線超過15分鐘。\n- 2025.8.26 10:26: 系統發出告警，資源 Edge SW11 (88.201.0.11) 斷線超過15分鐘。\n\n**3. 影響評估:**\n由於斷線資源為分行核心交換器，預期將造成以下影響：\n- 分行所有員工的電腦無法上網及存取內部資源。\n- 分行對外業務系統 (如：交易系統) 可能中斷。\n- IP 電話、印表機等網路資源無法使用。\n\n**4. 根本原因分析:**\n兩台位於同一分行的核心交換器在完全相同的時間點斷線，極不可能是單一資源故障。最可能的原因指向該分行的**上層網路或基礎設施問題**，例如：\n- **總電源中斷：** 該分行或機櫃發生跳電。\n- **上聯路由器故障：** 連接總公司的主要路由器 (Router) 當機或斷線。\n- **線路問題：** 該分行的主要對外線路中斷。\n\n**5. 後續處理建議:**\n- **立即行動：** 立刻聯繫仁愛分行IT人員，確認現場電力與主要路由器狀態。\n- **中期追蹤：** 若為電力問題，建議檢查UPS不斷電系統是否正常運作。若為線路問題，需聯繫網路服務供應商 (ISP) 報修。\n- **長期改善：** 評估為仁愛分行建立備援線路的可能性，以提高網路服務的可靠性。`;
        }
        return "無法分析，請檢查您的請求。";
      }
    }

    // --- Incident Management Logic ---
    function initializeIncidentManagement() {
      const logsBody = document.getElementById('logs-table-body');
      const incidentModal = document.getElementById('incident-modal');
      const incidentModalBody = document.getElementById('incident-modal-body');
      let currentLogIndex = null;

      // Combined event listener for the logs table using event delegation
      logsBody.addEventListener('click', (e) => {
        const target = e.target;

        // Case 1: The "Ack" button is clicked
        if (target.classList.contains('ack-log-btn')) {
          const index = parseInt(target.dataset.index, 10);
          const log = mockData.logs[index];
          log.status = 'ack';
          log.acknowledgedBy = loggedInUser.name;
          log.assignee = loggedInUser.name;

          showFeedbackModal('告警已確認，狀態更新為「處理中」');

          setTimeout(() => {
            closeFeedbackModal();
            populateTables();
            populateDashboard();
          }, 1500);
        }
        // Case 2: The row itself is clicked (but not the Ack button or checkbox)
        else if (target.closest('.log-row') && !target.classList.contains('log-checkbox')) {
          const row = target.closest('.log-row');
          currentLogIndex = parseInt(row.dataset.index, 10);
          openIncidentModal(currentLogIndex);
        }
      });


      // Handle clicks inside the incident modal (event delegation)
      incidentModalBody.addEventListener('click', async (e) => {
        const log = mockData.logs[currentLogIndex];
        if (!log) return;

        // Acknowledge
        if (e.target.id === 'incident-ack-btn') {
          log.status = 'ack';
          log.acknowledgedBy = loggedInUser.name;
          if (!log.assignee) log.assignee = loggedInUser.name;
          updateAndClose();
        }

        // Resolve
        if (e.target.id === 'incident-resolve-btn') {
          log.status = 'resolved';
          updateAndClose();
        }

        // Re-open
        if (e.target.id === 'incident-reopen-btn') {
          log.status = 'new';
          log.assignee = null;
          log.acknowledgedBy = null;
          updateAndClose();
        }

        // AI Analyze
        if (e.target.id === 'incident-ai-analyze-btn') {
          closeIncidentModal();
          const geminiModal = document.getElementById('gemini-modal');
          const geminiModalContent = document.getElementById('gemini-modal-content');
          const logString = `時間: ${log.time}, 分行: ${log.branch}, 資源: ${log.name} (${log.ip}), 描述: ${log.desc}`;
          const prompt = `你是一位資深的網路維運專家。請針對以下這筆告警紀錄，用繁體中文提供簡潔的「根本原因推測」與「建議處理步驟」。請直接給出分析，不要有開場白。\n\n告警紀錄：\n${logString}`;

          geminiModal.classList.remove('hidden', 'opacity-0');
          geminiModal.classList.add('flex');
          setTimeout(() => geminiModal.querySelector('div').classList.remove('scale-95'), 10);
          geminiModalContent.innerHTML = `<div class="flex justify-center items-center h-32"><p>AI 正在分析中...</p></div>`;
          const result = await callGeminiAPI(prompt);
          geminiModalContent.innerHTML = `<div class="prose max-w-none">${result.replace(/\*\*(.*?):\*\*/g, '<h4>$1:</h4>').replace(/-\s(.*?)\n/g, '<li>$1</li>')}</div>`;
        }

        // Add Comment
        if (e.target.id === 'incident-add-comment-btn') {
          const commentInput = document.getElementById('incident-comment-input');
          if (commentInput.value.trim()) {
            log.comments.push({
              user: loggedInUser.name,
              text: commentInput.value.trim(),
              time: new Date().toLocaleString('sv-SE').slice(0, 16)
            });
            commentInput.value = '';
            openIncidentModal(currentLogIndex); // Re-render the modal with the new comment
          }
        }
      });

      // Handle assignee change
      incidentModalBody.addEventListener('change', (e) => {
        if (e.target.id === 'incident-assignee-select') {
          const log = mockData.logs[currentLogIndex];
          if (log) {
            log.assignee = e.target.value;
            populateTables(); // Update the table in the background
          }
        }
      });


      function updateAndClose() {
        populateTables();
        populateDashboard();
        closeIncidentModal();
      }

      function openIncidentModal(logIndex) {
        const log = mockData.logs[logIndex];
        if (!log) return;
        currentLogIndex = logIndex;

        const personnelOptions = mockData.personnel.map(p => `<option value="${p.name}" ${log.assignee === p.name ? 'selected' : ''}>${p.name}</option>`).join('');
        const commentsHtml = log.comments.map(c => `<div class="flex items-start space-x-3 mb-4"><div class="flex-shrink-0"><img class="inline-block h-8 w-8 rounded-full" src="https://placehold.co/100x100/94a3b8/ffffff?text=${c.user.charAt(0)}" alt=""></div><div><div class="text-sm"><a href="#" class="font-medium text-gray-900">${c.user}</a></div><div class="mt-1 text-sm text-gray-700 bg-slate-100 p-3 rounded-lg"><p>${c.text}</p></div><div class="mt-1 text-xs text-gray-500">${c.time}</div></div></div>`).join('');

        let actionButtonsHtml = '';
        if (log.status === 'new') {
          actionButtonsHtml = `<button id="incident-ack-btn" class="px-3 py-1.5 bg-yellow-500 text-white rounded-lg text-sm font-semibold hover:bg-yellow-600 transition-colors">確認收到 (Ack)</button>`;
        } else if (log.status === 'ack') {
          actionButtonsHtml = `<button id="incident-resolve-btn" class="px-3 py-1.5 bg-green-500 text-white rounded-lg text-sm font-semibold hover:bg-green-600 transition-colors">標記為已解決</button>
                                 <button id="incident-reopen-btn" class="px-3 py-1.5 bg-slate-500 text-white rounded-lg text-sm font-semibold hover:bg-slate-600 transition-colors">重新開啟</button>`;
        } else if (log.status === 'resolved') {
          actionButtonsHtml = `<button id="incident-reopen-btn" class="px-3 py-1.5 bg-slate-500 text-white rounded-lg text-sm font-semibold hover:bg-slate-600 transition-colors">重新開啟</button>`;
        }

        const statusMap = {
          'new': '<span class="text-red-600 font-semibold">新告警</span>',
          'ack': '<span class="text-yellow-600 font-semibold">處理中</span>',
          'resolved': '<span class="text-green-600 font-semibold">已解決</span>'
        };

        const incidentHtml = `
                  <div class="space-y-6">
                      <div>
                          <h4 class="font-bold text-lg text-slate-800">${log.name} - ${log.desc}</h4>
                          <p class="text-sm text-slate-500">${log.time} 於 ${log.branch} (${log.ip})</p>
                      </div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                          <div><span class="font-semibold text-slate-600">處理狀態:</span> ${statusMap[log.status]}</div>
                          <div><span class="font-semibold text-slate-600">確認人員:</span> ${log.acknowledgedBy || '-'}</div>
                          <div><label for="incident-assignee-select" class="font-semibold text-slate-600">指派給:</label> <select id="incident-assignee-select" class="ml-2 rounded-md border-slate-300 text-sm"><option value="">未指派</option>${personnelOptions}</select></div>
                      </div>
                      <div class="flex gap-2 flex-wrap">
                           ${actionButtonsHtml}
                           <button id="incident-ai-analyze-btn" class="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm font-semibold flex items-center gap-2 hover:bg-purple-700 transition-colors">✨ AI 分析</button>
                      </div>
                      <div class="border-t pt-4">
                          <h5 class="font-bold text-slate-800 mb-4">處理紀錄</h5>
                          <div class="space-y-4 max-h-48 overflow-y-auto pr-2">${commentsHtml || '<p class="text-sm text-slate-500">尚無處理紀錄。</p>'}</div>
                          <div class="mt-4 border-t pt-4">
                              <textarea id="incident-comment-input" rows="3" class="w-full rounded-md border-slate-300" placeholder="新增處理紀錄..."></textarea>
                              <button id="incident-add-comment-btn" class="mt-2 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors">新增紀錄</button>
                          </div>
                      </div>
                  </div>
               `;
        incidentModalBody.innerHTML = incidentHtml;
        incidentModal.classList.remove('hidden', 'opacity-0');
        incidentModal.classList.add('flex');
        setTimeout(() => incidentModal.querySelector('div').classList.remove('scale-95'), 10);
      }

      function closeIncidentModal() {
        const modal = document.getElementById('incident-modal');
        modal.querySelector('div').classList.add('scale-95');
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
      }

      document.getElementById('incident-modal').addEventListener('click', e => {
        if (e.target.classList.contains('close-modal-btn') || e.target.id === 'incident-modal') {
          closeIncidentModal();
        }
      });
    }

    // --- Batch Operations Functions ---
    function initializeBatchOperations() {
      const selectAllResources = document.getElementById('select-all-resources');
      const batchOperationsBar = document.getElementById('batch-operations-bar');
      const selectedCount = document.getElementById('selected-count');
      const clearSelectionBtn = document.getElementById('clear-selection-btn');
      const batchDeleteBtn = document.getElementById('batch-delete-btn');
      const batchAddToGroupBtn = document.getElementById('batch-add-to-group-btn');
      const batchRemoveFromGroupBtn = document.getElementById('batch-remove-from-group-btn');

      function updateBatchOperationsBar() {
        const checkedBoxes = document.querySelectorAll('.resource-checkbox:checked');
        const count = checkedBoxes.length;
        selectedCount.textContent = count;

        if (count > 0) {
          batchOperationsBar.classList.remove('hidden');
        } else {
          batchOperationsBar.classList.add('hidden');
        }

        // Update select all checkbox state
        const allCheckboxes = document.querySelectorAll('.resource-checkbox');
        selectAllResources.checked = count === allCheckboxes.length;
        selectAllResources.indeterminate = count > 0 && count < allCheckboxes.length;
      }

      // Select all resources
      selectAllResources.addEventListener('change', (e) => {
        document.querySelectorAll('.resource-checkbox').forEach(cb => {
          cb.checked = e.target.checked;
        });
        updateBatchOperationsBar();
      });

      // Individual resource selection
      document.addEventListener('change', (e) => {
        if (e.target.classList.contains('resource-checkbox')) {
          updateBatchOperationsBar();
        }
      });

      // Clear selection
      clearSelectionBtn.addEventListener('click', () => {
        document.querySelectorAll('.resource-checkbox').forEach(cb => cb.checked = false);
        selectAllResources.checked = false;
        updateBatchOperationsBar();
      });

      // Batch operations
      batchDeleteBtn.addEventListener('click', () => {
        const selectedResources = Array.from(document.querySelectorAll('.resource-checkbox:checked'));
        openConfirmModal(`您確定要刪除選取的 ${selectedResources.length} 個資源嗎？`, 'batch-delete-resources', selectedResources.map(cb => cb.dataset.resourceId));
      });

      batchAddToGroupBtn.addEventListener('click', () => {
        const selectedResources = Array.from(document.querySelectorAll('.resource-checkbox:checked'));
        const groupCheckboxes = mockData.resourceGroups.map(g => `<div class="relative flex items-start"><div class="flex h-6 items-center"><input id="batch-group-${g.id}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div><div class="ml-3 text-sm leading-6"><label for="batch-group-${g.id}" class="font-medium text-gray-900">${g.name}</label></div></div>`).join('');
        const formHtml = `
          <div class="space-y-4">
            <p class="text-sm text-slate-600">將選取的 ${selectedResources.length} 個資源加入以下群組：</p>
            <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">選擇群組</legend><div class="space-y-2 mt-2 max-h-40 overflow-y-auto">${groupCheckboxes}</div></fieldset>
          </div>`;
        const formModal = document.getElementById('form-modal');
        const formModalTitle = document.getElementById('form-modal-title');
        const formModalBody = document.getElementById('form-modal-body');
        formModalTitle.textContent = '批次加入群組';
        formModalBody.innerHTML = formHtml;
        formModal.classList.remove('hidden', 'opacity-0');
        formModal.classList.add('flex');
        setTimeout(() => formModal.querySelector('div').classList.remove('scale-95'), 10);
      });

      batchRemoveFromGroupBtn.addEventListener('click', () => {
        const selectedResources = Array.from(document.querySelectorAll('.resource-checkbox:checked'));
        const groupCheckboxes = mockData.resourceGroups.map(g => `<div class="relative flex items-start"><div class="flex h-6 items-center"><input id="batch-remove-group-${g.id}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600"></div><div class="ml-3 text-sm leading-6"><label for="batch-remove-group-${g.id}" class="font-medium text-gray-900">${g.name}</label></div></div>`).join('');
        const formHtml = `
          <div class="space-y-4">
            <p class="text-sm text-slate-600">將選取的 ${selectedResources.length} 個資源從以下群組移除：</p>
            <fieldset class="mt-4"><legend class="text-sm font-medium text-slate-700 mb-2">選擇群組</legend><div class="space-y-2 mt-2 max-h-40 overflow-y-auto">${groupCheckboxes}</div></fieldset>
          </div>`;
        const formModal = document.getElementById('form-modal');
        const formModalTitle = document.getElementById('form-modal-title');
        const formModalBody = document.getElementById('form-modal-body');
        formModalTitle.textContent = '批次移出群組';
        formModalBody.innerHTML = formHtml;
        formModal.classList.remove('hidden', 'opacity-0');
        formModal.classList.add('flex');
        setTimeout(() => formModal.querySelector('div').classList.remove('scale-95'), 10);
      });

      // resource search functionality
      const resourceSearchInput = document.getElementById('resource-search-input');
      if (resourceSearchInput) {
        resourceSearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const resourceRows = document.querySelectorAll('#resources-table-body tr');

          resourceRows.forEach(row => {
            const resourceName = row.querySelector('[data-label="資源名稱"]')?.textContent.toLowerCase() || '';
            const resourceIP = row.querySelector('[data-label="IP 位址"]')?.textContent.toLowerCase() || '';

            if (resourceName.includes(searchTerm) || resourceIP.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      }

      // Network scan functionality
      const scanNetworkBtn = document.getElementById('scan-network-btn');
      if (scanNetworkBtn) {
        scanNetworkBtn.addEventListener('click', () => {
          const formHtml = `
            <div class="space-y-4">
              <div>
                <label class="text-sm font-medium text-slate-700">網段範圍</label>
                <input type="text" placeholder="例如：192.168.1.0/24" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
              </div>
              <div>
                <label class="text-sm font-medium text-slate-700">掃描方式</label>
                <select class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                  <option>SNMP 掃描</option>
                  <option>Ping 掃描</option>
                  <option>Port 掃描</option>
                </select>
              </div>
              <div class="bg-blue-50 p-4 rounded-lg">
                <p class="text-sm text-blue-800">
                  <strong>提示：</strong>掃描將會自動發現網段內的活躍資源，並可選擇批次匯入到系統中。
                </p>
              </div>
            </div>`;

          const formModal = document.getElementById('form-modal');
          const formModalTitle = document.getElementById('form-modal-title');
          const formModalBody = document.getElementById('form-modal-body');
          formModalTitle.textContent = '網段掃描';
          formModalBody.innerHTML = formHtml;

          // Override save button for scan functionality
          const saveBtn = document.getElementById('form-modal-save-btn');
          const originalSaveHandler = saveBtn.onclick;
          saveBtn.textContent = '開始掃描';
          saveBtn.onclick = () => {
            // Simulate network scan
            showFeedbackModal('正在掃描網段，請稍候...');
            setTimeout(() => {
              closeFeedbackModal();

              // Simulate discovered resources
              const discoveredResources = [
                { name: 'Router-Gateway', ip: '192.168.1.1', type: 'Router' },
                { name: 'Switch-Core', ip: '192.168.1.10', type: 'Switch' },
                { name: 'AP-Office', ip: '192.168.1.20', type: 'AP' },
                { name: 'Server-DB', ip: '192.168.1.100', type: 'Server' }
              ];

              const resultsHtml = `
                <div class="space-y-4">
                  <h4 class="font-semibold text-slate-800">掃描結果 (發現 ${discoveredResources.length} 個資源)</h4>
                  <div class="max-h-60 overflow-y-auto">
                    ${discoveredResources.map((resource, index) => `
                      <div class="flex items-center space-x-3 p-3 border rounded-lg">
                        <input type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                        <div class="flex-1">
                          <p class="font-medium text-slate-900">${resource.name}</p>
                          <p class="text-sm text-slate-500">${resource.ip} - ${resource.type}</p>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                  <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-green-800">選擇要匯入的資源，點擊「匯入資源」完成批次新增。</p>
                  </div>
                </div>`;

              formModalBody.innerHTML = resultsHtml;
              saveBtn.textContent = '匯入資源';
              saveBtn.onclick = () => {
                // Simulate import
                showFeedbackModal('資源匯入成功！');
                setTimeout(() => {
                  closeFeedbackModal();
                  document.querySelector('.close-modal-btn').click();
                  populateTables(); // Refresh the table
                }, 1500);
              };
            }, 3000);
          };

          formModal.classList.remove('hidden', 'opacity-0');
          formModal.classList.add('flex');
          setTimeout(() => formModal.querySelector('div').classList.remove('scale-95'), 10);
        });
      }
    }

    // --- Automation Features Functions ---
    function initializeAutomationFeatures() {
      const scriptsTab = document.getElementById('scripts-tab');
      const executionLogsTab = document.getElementById('execution-logs-tab');
      const scriptsContent = document.getElementById('scripts-content');
      const executionLogsContent = document.getElementById('execution-logs-content');
      const addScriptBtn = document.getElementById('add-script-btn');

      // Tab switching
      scriptsTab.addEventListener('click', () => {
        scriptsTab.classList.remove('border-transparent', 'text-gray-500');
        scriptsTab.classList.add('border-blue-600', 'text-blue-600');
        executionLogsTab.classList.remove('border-blue-600', 'text-blue-600');
        executionLogsTab.classList.add('border-transparent', 'text-gray-500');
        scriptsContent.classList.remove('hidden');
        executionLogsContent.classList.add('hidden');
      });

      executionLogsTab.addEventListener('click', () => {
        executionLogsTab.classList.remove('border-transparent', 'text-gray-500');
        executionLogsTab.classList.add('border-blue-600', 'text-blue-600');
        scriptsTab.classList.remove('border-blue-600', 'text-blue-600');
        scriptsTab.classList.add('border-transparent', 'text-gray-500');
        executionLogsContent.classList.remove('hidden');
        scriptsContent.classList.add('hidden');
      });

      // Add script
      addScriptBtn.addEventListener('click', () => {
        const formHtml = `
          <div class="space-y-4">
            <div><label class="text-sm font-medium text-slate-700">腳本名稱</label><input type="text" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
            <div><label class="text-sm font-medium text-slate-700">腳本類型</label>
              <select class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                <option>Shell Script</option>
                <option>Ansible Playbook</option>
                <option>Python Script</option>
              </select>
            </div>
            <div><label class="text-sm font-medium text-slate-700">描述</label><textarea rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea></div>
            <div><label class="text-sm font-medium text-slate-700">腳本內容</label><textarea rows="8" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm font-mono text-xs" placeholder="#!/bin/bash&#10;# 在此輸入腳本內容"></textarea></div>
            <div><label class="text-sm font-medium text-slate-700">參數定義 (以逗號分隔)</label><input type="text" placeholder="host_ip,service_name" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
          </div>`;
        const formModal = document.getElementById('form-modal');
        const formModalTitle = document.getElementById('form-modal-title');
        const formModalBody = document.getElementById('form-modal-body');
        formModalTitle.textContent = '新增自動化腳本';
        formModalBody.innerHTML = formHtml;

        // Set current action for save button
        window.currentAction = 'add-script';
        window.currentEditIndex = null;

        formModal.classList.remove('hidden', 'opacity-0');
        formModal.classList.add('flex');
        setTimeout(() => formModal.querySelector('div').classList.remove('scale-95'), 10);
      });

      // Script actions
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('test-script-btn')) {
          const row = e.target.closest('tr');
          const index = row.dataset.index;
          const script = mockData.automationScripts[index];

          // Simulate script test execution
          showFeedbackModal(`正在測試腳本「${script.name}」...`);
          setTimeout(() => {
            closeFeedbackModal();
            // Add a test execution log
            const testLog = {
              id: mockData.executionLogs.length + 1,
              executionTime: new Date().toLocaleString('sv-SE').slice(0, 16).replace('T', ' '),
              scriptName: script.name,
              triggerAlert: '手動測試',
              status: Math.random() > 0.3 ? 'success' : 'failed',
              duration: Math.floor(Math.random() * 30 + 5) + 's',
              output: Math.random() > 0.3 ?
                `Test execution completed successfully\nScript: ${script.name}\nParameters: test_mode=true\nResult: OK` :
                `Test execution failed\nScript: ${script.name}\nError: Connection timeout\nExit code: 1`
            };
            mockData.executionLogs.unshift(testLog);
            populateTables();
            showFeedbackModal(`腳本「${script.name}」測試完成！`);
            setTimeout(closeFeedbackModal, 2000);
          }, 2000);
        }

        if (e.target.classList.contains('edit-script-btn')) {
          const row = e.target.closest('tr');
          const index = row.dataset.index;
          const script = mockData.automationScripts[index];

          const formHtml = `
            <div class="space-y-4">
              <div><label class="text-sm font-medium text-slate-700">腳本名稱</label><input type="text" value="${script.name}" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
              <div><label class="text-sm font-medium text-slate-700">腳本類型</label>
                <select class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                  <option ${script.type === 'Shell Script' ? 'selected' : ''}>Shell Script</option>
                  <option ${script.type === 'Ansible Playbook' ? 'selected' : ''}>Ansible Playbook</option>
                  <option ${script.type === 'Python Script' ? 'selected' : ''}>Python Script</option>
                </select>
              </div>
              <div><label class="text-sm font-medium text-slate-700">描述</label><textarea rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">${script.description}</textarea></div>
              <div><label class="text-sm font-medium text-slate-700">腳本內容</label><textarea rows="8" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm font-mono text-xs" placeholder="#!/bin/bash&#10;# 在此輸入腳本內容">${script.type === 'Shell Script' ? '#!/bin/bash\n# ' + script.description + '\necho "Executing script..."\n# Add your script logic here' : script.type === 'Python Script' ? '#!/usr/bin/env python3\n# ' + script.description + '\nimport sys\nprint("Executing script...")\n# Add your script logic here' : '---\n# ' + script.description + '\n- name: Execute task\n  debug:\n    msg: "Executing playbook..."'}</textarea></div>
              <div><label class="text-sm font-medium text-slate-700">參數定義 (以逗號分隔)</label><input type="text" value="${script.parameters.join(',')}" placeholder="host_ip,service_name" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
            </div>`;

          const formModal = document.getElementById('form-modal');
          const formModalTitle = document.getElementById('form-modal-title');
          const formModalBody = document.getElementById('form-modal-body');
          formModalTitle.textContent = '編輯自動化腳本';
          formModalBody.innerHTML = formHtml;

          // Set current action for save button
          window.currentAction = 'edit-script';
          window.currentEditIndex = index;

          formModal.classList.remove('hidden', 'opacity-0');
          formModal.classList.add('flex');
          setTimeout(() => formModal.querySelector('div').classList.remove('scale-95'), 10);
        }

        if (e.target.classList.contains('delete-script-btn')) {
          const row = e.target.closest('tr');
          const index = row.dataset.index;
          const script = mockData.automationScripts[index];

          const confirmModal = document.getElementById('confirm-modal');
          document.getElementById('confirm-modal-text').textContent = `您確定要刪除腳本「${script.name}」嗎？`;
          const confirmBtn = document.getElementById('confirm-action-btn');
          confirmBtn.className = 'text-white bg-red-600 hover:bg-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2 transition-colors';
          confirmBtn.textContent = '確定刪除';

          confirmModal.classList.remove('hidden', 'opacity-0');
          confirmModal.classList.add('flex');
          setTimeout(() => confirmModal.querySelector('div').classList.remove('scale-95'), 10);

          // Handle delete confirmation
          confirmBtn.onclick = () => {
            mockData.automationScripts.splice(index, 1);
            populateTables();
            confirmModal.querySelector('div').classList.add('scale-95');
            confirmModal.classList.add('opacity-0');
            setTimeout(() => confirmModal.classList.add('hidden'), 300);
            showFeedbackModal(`腳本「${script.name}」已刪除！`);
            setTimeout(closeFeedbackModal, 1500);
          };
        }

        if (e.target.classList.contains('view-output-btn')) {
          const index = e.target.closest('tr').dataset.index;
          const log = mockData.executionLogs[index];
          const outputHtml = `
            <div class="space-y-4">
              <div class="bg-slate-50 p-4 rounded-lg">
                <h4 class="font-semibold text-slate-800 mb-2">執行資訊</h4>
                <div class="text-sm space-y-1">
                  <p><span class="font-medium">腳本：</span>${log.scriptName}</p>
                  <p><span class="font-medium">觸發告警：</span>${log.triggerAlert}</p>
                  <p><span class="font-medium">執行時間：</span>${log.executionTime}</p>
                  <p><span class="font-medium">執行時長：</span>${log.duration}</p>
                </div>
              </div>
              <div>
                <h4 class="font-semibold text-slate-800 mb-2">執行輸出</h4>
                <pre class="bg-black text-green-400 p-4 rounded-lg text-sm overflow-x-auto">${log.output}</pre>
              </div>
            </div>`;
          const formModal = document.getElementById('form-modal');
          const formModalTitle = document.getElementById('form-modal-title');
          const formModalBody = document.getElementById('form-modal-body');
          formModalTitle.textContent = '執行日誌詳情';
          formModalBody.innerHTML = outputHtml;
          formModal.classList.remove('hidden', 'opacity-0');
          formModal.classList.add('flex');
          setTimeout(() => formModal.querySelector('div').classList.remove('scale-95'), 10);
        }
      });

      // Filter logs functionality
      document.getElementById('filter-logs-btn').addEventListener('click', () => {
        const startDate = document.getElementById('log-start-date').value;
        const endDate = document.getElementById('log-end-date').value;
        const statusFilter = document.getElementById('log-status-filter').value;

        let filteredLogs = [...mockData.executionLogs];

        if (startDate) {
          filteredLogs = filteredLogs.filter(log => log.executionTime >= startDate);
        }
        if (endDate) {
          filteredLogs = filteredLogs.filter(log => log.executionTime <= endDate + ' 23:59');
        }
        if (statusFilter) {
          filteredLogs = filteredLogs.filter(log => log.status === statusFilter);
        }

        // Update execution logs table with filtered data
        const executionLogsBody = document.getElementById('execution-logs-table-body');
        if (executionLogsBody) {
          executionLogsBody.innerHTML = '';
          filteredLogs.forEach((log, index) => {
            const statusBadge = log.status === 'success' ? '<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">成功</span>' :
              '<span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">失敗</span>';
            const row = `<tr class="bg-white" data-index="${mockData.executionLogs.indexOf(log)}">
                            <td data-label="執行時間" class="px-6 py-4">${log.executionTime}</td>
                            <td data-label="腳本名稱" class="px-6 py-4 font-medium text-slate-900">${log.scriptName}</td>
                            <td data-label="觸發告警" class="px-6 py-4">${log.triggerAlert}</td>
                            <td data-label="執行狀態" class="px-6 py-4">${statusBadge}</td>
                            <td data-label="執行時長" class="px-6 py-4">${log.duration}</td>
                            <td data-label="操作" class="px-6 py-4 text-left md:text-center">
                                <button class="view-output-btn text-blue-600 hover:text-blue-800 font-medium">查看輸出</button>
                            </td></tr>`;
            executionLogsBody.innerHTML += row;
          });
        }

        showFeedbackModal(`已篩選出 ${filteredLogs.length} 筆執行日誌`);
        setTimeout(closeFeedbackModal, 1500);
      });
    }

    // --- Capacity Planning Functions ---
    function initializeCapacityPlanning() {
      const targetGroupSelect = document.getElementById('capacity-target-group');
      const metricSelect = document.getElementById('capacity-metric');
      const analyzeBtn = document.getElementById('analyze-capacity-btn');
      const resultsDiv = document.getElementById('capacity-results');
      let capacityChart = null;

      // Initialize dropdowns for the first time
      if (targetGroupSelect && targetGroupSelect.children.length <= 1) {
        populateTargetGroupDropdown();
      }
      // Set initial state for metric dropdown
      if (metricSelect.value === '') {
        metricSelect.innerHTML = '<option value="">請先選擇群組</option>';
        metricSelect.disabled = true;
      }


      // Prevent multiple event listener bindings
      if (targetGroupSelect && !targetGroupSelect.hasAttribute('data-initialized')) {
        targetGroupSelect.setAttribute('data-initialized', 'true');

        // Update metrics when group is selected
        targetGroupSelect.addEventListener('change', (e) => {
          const groupId = e.target.value;
          if (metricSelect) {
            if (groupId) {
              metricSelect.innerHTML = '<option value="">請選擇指標</option>';
              Object.entries(mockData.capacityMetrics).forEach(([key, metric]) => {
                const selected = metricSelect.dataset.lastSelection === key ? 'selected' : '';
                metricSelect.innerHTML += `<option value="${key}" ${selected}>${metric.name}</option>`;
              });
              if (metricSelect.dataset.lastSelection) {
                metricSelect.value = metricSelect.dataset.lastSelection;
              }
              metricSelect.disabled = false;
            } else {
              // No group is selected, reset and disable
              metricSelect.innerHTML = '<option value="">請先選擇群組</option>';
              metricSelect.disabled = true;
            }
            updateAnalyzeButtonState();
          }
        });
      }

      // Store the selection in a data attribute
      if (metricSelect && !metricSelect.hasAttribute('data-initialized')) {
        metricSelect.setAttribute('data-initialized', 'true');
        metricSelect.addEventListener('change', (e) => {
          if (e.target.value) {
            metricSelect.dataset.lastSelection = e.target.value;
          }
          updateAnalyzeButtonState();
        });
      }

      // Analyze capacity click handler
      if (analyzeBtn && !analyzeBtn.hasAttribute('data-initialized')) {
        analyzeBtn.setAttribute('data-initialized', 'true');
        analyzeBtn.addEventListener('click', async () => {
          const groupId = targetGroupSelect.value;
          const metric = metricSelect.value;
          if (!groupId || !metric) return;

          const groupName = targetGroupSelect.options[targetGroupSelect.selectedIndex].text;
          const metricName = mockData.capacityMetrics[metric].name;

          analyzeBtn.disabled = true;
          analyzeBtn.textContent = '分析中...';
          await new Promise(resolve => setTimeout(resolve, 2000));
          const mockResults = generateMockCapacityAnalysis(metric);

          const growthRateEl = document.getElementById('growth-rate');
          const warningEtaEl = document.getElementById('warning-eta');
          const depletionEtaEl = document.getElementById('depletion-eta');
          if (growthRateEl) growthRateEl.textContent = mockResults.growthRate;
          if (warningEtaEl) warningEtaEl.textContent = mockResults.warningEta;
          if (depletionEtaEl) depletionEtaEl.textContent = mockResults.depletionEta;

          const recommendationsDiv = document.getElementById('capacity-recommendations');
          if (recommendationsDiv) {
            recommendationsDiv.innerHTML = mockResults.recommendations.map(rec =>
              `<div class="flex items-start space-x-3">
                  <div class="flex-shrink-0 mt-1"><div class="h-2 w-2 rounded-full bg-blue-500"></div></div>
                  <p class="text-sm text-slate-700">${rec}</p>
                </div>`
            ).join('');
          }

          createCapacityTrendChart(mockResults.chartData, metricName);
          if (resultsDiv) {
            resultsDiv.classList.remove('hidden');
          }

          analyzeBtn.disabled = false;
          analyzeBtn.textContent = '重新分析';
        });
      }

      function generateMockCapacityAnalysis(metric) {
        const baseGrowthRates = { 'cpu_usage': '2.3%', 'memory_usage': '5.2%', 'disk_usage': '8.1%', 'network_traffic': '12.5%' };
        const baseWarningEtas = { 'cpu_usage': '120 天後', 'memory_usage': '45 天後', 'disk_usage': '30 天後', 'network_traffic': '15 天後' };
        const baseDepletionEtas = { 'cpu_usage': '180 天後', 'memory_usage': '65 天後', 'disk_usage': '45 天後', 'network_traffic': '25 天後' };
        const recommendations = {
          'cpu_usage': ['建議監控 CPU 使用率較高的服務，考慮優化或擴容', '評估是否需要增加伺服器節點來分散負載', '檢查是否有異常程序消耗過多 CPU 資源'],
          'memory_usage': ['建議盡快規劃記憶體擴充，預計 45 天後達到警戒線', '檢查應用程式是否存在記憶體洩漏問題', '考慮實施記憶體快取策略優化'],
          'disk_usage': ['緊急建議：磁碟空間即將不足，需立即清理或擴容', '建立自動化日誌清理機制', '評估資料歸檔策略，將舊資料移至冷儲存'],
          'network_traffic': ['網路流量增長快速，建議評估頻寬升級需求', '檢查是否有異常流量或攻擊行為', '考慮實施流量優化和 CDN 策略']
        };
        const chartData = { labels: [], historical: [], predicted: [] };
        const now = new Date();
        for (let i = 90; i >= 0; i--) {
          const date = new Date(now);
          date.setDate(date.getDate() - i);
          chartData.labels.push(date.toISOString().slice(5, 10));
          const baseValue = 30 + (90 - i) * 0.3 + Math.random() * 10;
          chartData.historical.push(Math.min(baseValue, 95));
        }
        for (let i = 1; i <= 60; i++) {
          const date = new Date(now);
          date.setDate(date.getDate() + i);
          chartData.labels.push(date.toISOString().slice(5, 10));
          const lastValue = chartData.historical[chartData.historical.length - 1];
          const predictedValue = lastValue + i * 0.5 + Math.random() * 2;
          chartData.predicted.push(Math.min(predictedValue, 100));
        }
        return { growthRate: baseGrowthRates[metric], warningEta: baseWarningEtas[metric], depletionEta: baseDepletionEtas[metric], recommendations: recommendations[metric], chartData: chartData };
      }

      function createCapacityTrendChart(data, metricName) {
        const ctx = document.getElementById('capacityTrendChart').getContext('2d');
        if (capacityChart) { capacityChart.destroy(); }
        capacityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [
              { label: `歷史 ${metricName}`, data: data.historical.concat(Array(data.predicted.length).fill(null)), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 },
              { label: `預測 ${metricName}`, data: Array(data.historical.length).fill(null).concat(data.predicted), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', borderDash: [5, 5], fill: false, tension: 0.4 },
              { label: '80% 警戒線', data: Array(data.labels.length).fill(80), borderColor: '#ef4444', borderWidth: 1, pointRadius: 0, fill: false }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, max: 100, ticks: { callback: function (value) { return value + '%'; } } }, x: { ticks: { maxTicksLimit: 10 } } },
            plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function (context) { return context.dataset.label + ': ' + context.parsed.y + '%'; } } } }
          }
        });
      }
    }

    // --- Helper functions for capacity planning ---
    function populateTargetGroupDropdown() {
      const targetGroupSelect = document.getElementById('capacity-target-group');
      if (!targetGroupSelect) return;
      const currentSelection = targetGroupSelect.value;
      const userRole = loggedInUser?.role;
      let visibleGroups = mockData.resourceGroups;
      if (userRole === 'TeamManager' || userRole === 'TeamMember') {
        const managedTeamIds = userRole === 'TeamManager' ? loggedInUser.managesTeamIds : mockData.personnel.find(p => p.name === loggedInUser.name)?.teamIds || [];
        const visibleTeams = mockData.teams.filter(t => managedTeamIds.includes(t.id));
        const accessibleGroupIds = new Set();
        visibleTeams.forEach(team => { team.accessibleGroupIds.forEach(id => accessibleGroupIds.add(id)); });
        visibleGroups = mockData.resourceGroups.filter(g => accessibleGroupIds.has(g.id));
      }
      targetGroupSelect.innerHTML = '<option value="">請選擇資源群組</option>';
      visibleGroups.forEach(group => {
        const selected = currentSelection === group.id.toString() ? 'selected' : '';
        targetGroupSelect.innerHTML += `<option value="${group.id}" ${selected}>${group.name}</option>`;
      });
    }

    function updateAnalyzeButtonState() {
      const targetGroupSelect = document.getElementById('capacity-target-group');
      const metricSelect = document.getElementById('capacity-metric');
      const analyzeBtn = document.getElementById('analyze-capacity-btn');
      if (analyzeBtn && targetGroupSelect && metricSelect) {
        analyzeBtn.disabled = !targetGroupSelect.value || !metricSelect.value;
      }
    }

    function updateCapacityDropdowns() {
      // This function is called on re-renders. We just need to repopulate the group dropdown.
      // The event listeners on the elements will handle the rest.
      populateTargetGroupDropdown();
      // Manually trigger change to re-evaluate metric dropdown state
      document.getElementById('capacity-target-group').dispatchEvent(new Event('change'));
    }

    // --- Profile Page Functions ---
    function initializeProfileTabs() {
      const tabs = document.querySelectorAll('.profile-tab');
      const tabContents = document.querySelectorAll('.profile-tab-content');

      function updateTabs(activeTab) {
        tabs.forEach(tab => {
          if (tab === activeTab) {
            tab.classList.add('border-blue-600', 'text-blue-600');
            tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
          } else {
            tab.classList.remove('border-blue-600', 'text-blue-600');
            tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
          }
        });

        const targetId = activeTab.dataset.tab;
        tabContents.forEach(content => {
          content.classList.toggle('hidden', content.id !== `tab-${targetId}`);
        });
      }

      tabs.forEach(tab => {
        tab.addEventListener('click', () => updateTabs(tab));
      });

      // Set initial state from the first tab
      if (tabs.length > 0) {
        updateTabs(tabs[0]);
      }
    }
    function updateContactMethodUI(method) {
      if (!loggedInUser) return;

      const propName = method === 'line-token' ? 'lineToken' : method;
      const input = document.getElementById(`profile-${method}`);
      const statusEl = document.getElementById(`${method}-status`);
      const actionBtn = document.getElementById(`${method}-action-btn`);

      const value = loggedInUser[propName] || '';
      const verified = loggedInUser[`${propName}Verified`] || false;

      const baseBtnClass = 'w-28 justify-center px-3 py-1.5 rounded-lg font-semibold transition-colors text-sm flex-shrink-0';
      const baseStatusClass = 'text-sm font-medium w-20 text-center flex-shrink-0';

      if (input) input.value = value;

      if (!value) {
        if (statusEl) statusEl.textContent = '';
        if (statusEl) statusEl.className = baseStatusClass;
        if (actionBtn) actionBtn.textContent = '儲存';
        if (actionBtn) actionBtn.dataset.action = 'save';
        if (actionBtn) actionBtn.className = `${baseBtnClass} bg-slate-600 text-white hover:bg-slate-700`;
      } else if (verified) {
        if (statusEl) statusEl.textContent = '已驗證';
        if (statusEl) statusEl.className = `${baseStatusClass} text-green-600`;
        if (actionBtn) actionBtn.textContent = '測試';
        if (actionBtn) actionBtn.dataset.action = 'test';
        if (actionBtn) actionBtn.className = `${baseBtnClass} bg-green-600 text-white hover:bg-green-700`;
      } else {
        if (statusEl) statusEl.textContent = '未驗證';
        if (statusEl) statusEl.className = `${baseStatusClass} text-slate-500`;
        if (actionBtn) actionBtn.textContent = '傳送驗證';
        if (actionBtn) actionBtn.dataset.action = 'verify';
        if (actionBtn) actionBtn.className = `${baseBtnClass} bg-blue-600 text-white hover:bg-blue-700`;
      }
    }

    function populateProfilePage() {
      if (!loggedInUser) return;

      // Populate profile information
      const profileNameInput = document.getElementById('profile-name-input');
      const profileRole = document.getElementById('profile-role');

      if (profileNameInput) profileNameInput.value = loggedInUser.name;
      if (profileRole) {
        const roleMap = {
          'SuperAdmin': '超級管理員',
          'TeamManager': '團隊管理員',
          'TeamMember': '一般使用者'
        };
        const roleText = roleMap[loggedInUser.role] || loggedInUser.role;
        let roleBadgeHtml;
        // Match style from personnel page
        switch (loggedInUser.role) {
          case 'SuperAdmin':
            roleBadgeHtml = `<span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${roleText}</span>`;
            break;
          case 'TeamManager':
            roleBadgeHtml = `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${roleText}</span>`;
            break;
          default:
            roleBadgeHtml = `<span class="bg-slate-100 text-slate-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${roleText}</span>`;
        }
        profileRole.innerHTML = roleBadgeHtml;
      }

      // Find user's teams and populate read-only tags
      const userPersonnel = mockData.personnel.find(p => p.name === loggedInUser.name);
      const profileTeamsTags = document.getElementById('profile-teams-tags');
      if (profileTeamsTags && userPersonnel) {
        profileTeamsTags.innerHTML = ''; // Clear existing tags
        const userTeams = mockData.teams.filter(team => userPersonnel.teamIds.includes(team.id));
        if (userTeams.length > 0) {
          userTeams.forEach(team => {
            const tag = document.createElement('span');
            tag.className = 'bg-slate-200 text-slate-700 text-sm font-medium px-3 py-1 rounded-full';
            tag.textContent = team.name;
            profileTeamsTags.appendChild(tag);
          });
        } else {
          profileTeamsTags.innerHTML = '<p class="text-slate-500 text-sm">未加入任何團隊</p>';
        }
      }

      // Populate contact info using the new UI updater
      updateContactMethodUI('email');
      updateContactMethodUI('line-token');
      updateContactMethodUI('sms');

      // Hide SMS verification code input initially
      const smsVerifyContainer = document.getElementById('sms-verify-container');
      if (smsVerifyContainer) {
        smsVerifyContainer.classList.add('hidden');
      }


      // Populate notification preferences
      const prefHigh = document.getElementById('pref-high');
      const prefMedium = document.getElementById('pref-medium');
      const prefLow = document.getElementById('pref-low');

      if (prefHigh) prefHigh.checked = loggedInUser.subscribedLevels?.includes('high') || false;
      if (prefMedium) prefMedium.checked = loggedInUser.subscribedLevels?.includes('medium') || false;
      if (prefLow) prefLow.checked = loggedInUser.subscribedLevels?.includes('low') || false;
    }

    function initializeSettingsTabs() {
      const tabs = document.querySelectorAll('.settings-tab');
      const tabContents = document.querySelectorAll('.settings-tab-content');

      function updateTabs(activeTab) {
        tabs.forEach(tab => {
          if (tab === activeTab) {
            tab.classList.add('border-blue-600', 'text-blue-600');
            tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
          } else {
            tab.classList.remove('border-blue-600', 'text-blue-600');
            tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
          }
        });

        const targetId = activeTab.dataset.tab;
        tabContents.forEach(content => {
          content.classList.toggle('hidden', content.id !== `tab-${targetId}`);
        });
      }

      tabs.forEach(tab => {
        tab.addEventListener('click', () => updateTabs(tab));
      });

      // Set initial state from the first tab
      if (tabs.length > 0) {
        updateTabs(tabs[0]);
      }
    }

    function initializeProfileActions() {
      // Save profile info
      const saveProfileInfoBtn = document.getElementById('save-profile-info-btn');
      if (saveProfileInfoBtn) {
        saveProfileInfoBtn.addEventListener('click', () => {
          const newName = document.getElementById('profile-name-input').value;
          const oldName = loggedInUser.name;
          loggedInUser.name = newName;
          const userInPersonnel = mockData.personnel.find(p => p.name === oldName || p.name === newName);
          if (userInPersonnel) userInPersonnel.name = newName;
          document.getElementById('user-name').textContent = newName;
          populateTables();
          populateProfilePage();
          showFeedbackModal('個人資訊已更新！');
          setTimeout(closeFeedbackModal, 1500);
        });
      }

      // Save password
      const savePasswordBtn = document.getElementById('save-password-btn');
      if (savePasswordBtn) {
        savePasswordBtn.addEventListener('click', () => {
          const currentPassword = document.getElementById('current-password').value;
          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;

          if (!currentPassword || !newPassword || !confirmPassword) {
            showFeedbackModal('請填寫所有密碼欄位');
            setTimeout(closeFeedbackModal, 2000);
            return;
          }

          if (newPassword !== confirmPassword) {
            showFeedbackModal('新密碼與確認密碼不符');
            setTimeout(closeFeedbackModal, 2000);
            return;
          }

          // Simulate password update
          showFeedbackModal('密碼已更新！');
          setTimeout(() => {
            closeFeedbackModal();
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
          }, 1500);
        });
      }

      // Delegated listener for contact method actions
      const contactContainer = document.getElementById('contact-methods-container');
      if (contactContainer) {
        contactContainer.addEventListener('click', e => {
          const button = e.target.closest('button[data-method]');
          if (!button) return;

          const method = button.dataset.method;
          const action = button.dataset.action;
          const inputId = `profile-${method}`;
          const input = document.getElementById(inputId);
          const userInPersonnel = mockData.personnel.find(p => p.name === loggedInUser.name);
          const propName = method === 'line-token' ? 'lineToken' : method;

          if (action === 'save') {
            loggedInUser[propName] = input.value;
            loggedInUser[`${propName}Verified`] = false;
            if (userInPersonnel) {
              userInPersonnel[propName] = input.value;
              userInPersonnel[`${propName}Verified`] = false;
            }
            showFeedbackModal(`${method.toUpperCase()} 資料已儲存，請進行驗證。`);
            setTimeout(closeFeedbackModal, 2000);
            updateContactMethodUI(method);
          } else if (action === 'verify') {
            showFeedbackModal(`驗證訊息已傳送到 ${input.value}`);
            setTimeout(closeFeedbackModal, 2000);
            button.textContent = '重新傳送';
            if (method === 'sms') {
              document.getElementById('sms-verify-container').classList.remove('hidden');
            }
          } else if (action === 'test') {
            showFeedbackModal(`測試訊息已傳送到 ${input.value}`);
            setTimeout(closeFeedbackModal, 2000);
          }
        });
      }

      // SMS Verification Code button
      const smsVerifyBtn = document.getElementById('sms-verify-btn');
      if (smsVerifyBtn) {
        smsVerifyBtn.addEventListener('click', () => {
          const codeInput = document.getElementById('sms-verify-code');
          if (codeInput.value === '123456') { // Mock verification
            loggedInUser.smsVerified = true;
            const userInPersonnel = mockData.personnel.find(p => p.name === loggedInUser.name);
            if (userInPersonnel) userInPersonnel.smsVerified = true;

            showFeedbackModal('SMS 已成功驗證！');
            setTimeout(closeFeedbackModal, 1500);
            document.getElementById('sms-verify-container').classList.add('hidden');
            updateContactMethodUI('sms');
          } else {
            showFeedbackModal('驗證碼錯誤！');
            setTimeout(closeFeedbackModal, 2000);
          }
        });
      }

      // Save preferences
      const savePrefsBtn = document.getElementById('save-prefs-btn');
      if (savePrefsBtn) {
        savePrefsBtn.addEventListener('click', () => {
          const subscribedLevels = [];
          if (document.getElementById('pref-high')?.checked) subscribedLevels.push('high');
          if (document.getElementById('pref-medium')?.checked) subscribedLevels.push('medium');
          if (document.getElementById('pref-low')?.checked) subscribedLevels.push('low');
          loggedInUser.subscribedLevels = subscribedLevels;
          const userInPersonnel = mockData.personnel.find(p => p.name === loggedInUser.name);
          if (userInPersonnel) userInPersonnel.subscribedLevels = subscribedLevels;
          showFeedbackModal('通知偏好已儲存！');
          setTimeout(closeFeedbackModal, 1500);
        });
      }
    }

  </script>
</body>

</html>