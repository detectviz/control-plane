# Control Plane - 規格暨技術架構書

**文件版本：** 16.0

**最後更新日期：** 2025年8月31日

## **1. 核心理念與技術選型**

本專案旨在打造一個名為 Control Plane 、後端驅動 (Backend-Driven) 的現代化維運平台。核心理念是將複雜性集中在我們最擅長的 Go 後端，同時保持前端的極度輕量與簡潔。我們將透過 HTMX 來實現豐富的互動體驗，而無需引入大型 JavaScript 框架及其複雜的工具鏈。

### **1.1 技術棧**

* **後端 (Backend):**  
  * 語言： Go  
  * Web 框架： 原生 net/http 或輕量級框架 (如 Gin, Echo)  
  * 模板引擎： Go 原生 html/template (核心)  
* **前端 (Frontend):**  
  * 核心： HTMX  
  * 樣式： Tailwind CSS  
  * 輔助腳本： Alpine.js (用於處理下拉選單、彈出視窗等客戶端互動)  
  * 進階選擇器 (Advanced Selector): Tom Select (用於取代原生 `<select>`，提供搜尋與多選功能)
  * 圖表： Chart.js (用於 Go 後端自行渲染的圖表)
* **核心服務 (Core Services):**  
  * 儀表板： Grafana (透過 <iframe> 嵌入)  
  * 身份驗證： Keycloak (實現 SSO)  
  * 監控引擎 (Monitoring Engine):  
    * 數據採集 (SNMP): vmagent + snmp_exporter  
    * 時序資料庫: VictoriaMetrics  
    * 告警引擎: Grafana Alerting  
  * 應用程式資料庫： PostgreSQL  
  * AI 輔助： Google Gemini API

### **1.2 非功能性需求 (Non-Functional Requirements)**

* **響應式設計 (RWD):** 平台介面必須完全響應式，確保在桌面、平板與行動裝置上皆有良好的瀏覽與操作體驗。  
* **使用者體驗 (UX):**  
  * **視覺風格:** 整體需遵循 web.html 原型所定義的現代化 UI 風格，包含專業的配色、清晰的字體、圓角卡片與陰影。  
  * **佈局:** 側邊選單 (Sidebar) 必須為全螢幕高度，確保在長頁面下佈局依然完整。  
  * **互動回饋:** 所有的互動元件（按鈕、連結、表單）都應提供清晰的視覺回饋（如 Hover 效果、Focus 狀態）。  
  * **過渡動畫:** 頁面片段的載入與切換、彈出視窗的顯示與隱藏，都應加入流暢、不突兀的過渡動畫，以提升操作的細膩度。

## **2. 系統架構與權限模型**

### **2.1 核心實體與資料關聯**

本平台圍繞以下核心實體建構，它們之間的關聯構成了權限與管理的核心邏輯：

* **資源 (Resource):** 最小的監控單元。可歸屬於多個「資源群組」。
* **資源群組 (Resource Group):** 由一或多個「資源」組成的邏輯集合。
* **人員 (Personnel):** 系統的使用者。每位人員負責管理自己的聯絡方式 (Email, LINE Token) 與希望接收的告警等級。人員透過歸屬於一或多個「團隊」來獲得權限。
* **通知管道 (Notification Channel):** 一個中立的通知發送媒介，例如一個共用的 Slack Webhook URL 或一個 Email 群組信箱。它本身不與任何團隊或人員綁定。
* **團隊 (Team):** 由一或多個「人員」組成的集合。團隊主要有兩個職責：
    1.  **權限賦予:** 團隊被授予查看特定「資源群組」的權限，團隊內的成員因此繼承這些權限。
    2.  **通知訂閱:** 團隊定義了一份「訂閱者 (Subscribers)」清單，決定了當與此團隊相關的告警發生時，通知應該發給誰。訂閱者可以是「人員」，也可以是「通知管道」。
* **告警規則 (Alert Rule):** 針對特定「資源群組」的監控條件設定，可選擇性關聯一條「自動化腳本」。
* **告警事件 (Alert Event / Incident):** 當「告警規則」被觸發時所產生的具體事件。  
* **維護時段 (Maintenance):** 用於在特定時間內抑制告警的排程。  
* **腳本庫 (Script Repository):** 儲存用於「自動化響應」的腳本（如 Shell Script, Ansible Playbook）。  
* **執行日誌 (Execution Log):** 記錄每一次自動化腳本的執行情況。

**核心權限邏輯：** 一位 **人員** 屬於某個 **團隊**，該 **團隊** 被授予查看特定 **資源群組** 的權限。因此，該人員登入後，只能看到其被授權的資源群組及其中的 **資源** 所產生的相關告警。

### **2.2 權限模型與認證流程**

採用標準的 OIDC (OpenID Connect) Authorization Code Flow 進行使用者認證，並以 Keycloak 作為權限管理的唯一真實來源 (Single Source of Truth)。

* **角色定義:**  
  * **超級管理員 (Super Admin):** 擁抱系統最高權限。  
  * **團隊管理員 (Team Manager):** 負責管理其團隊的日常運作。  
  * **一般使用者 (Team Member):** 平台的終端使用者，專注於監控與處理告警。  
* **認證流程:**  
  1. 使用者首次訪問平台，被重新導向至 Keycloak 登入頁面。  
  2. 登入成功後，Keycloak 將使用者帶回應用程式，並附帶一個授權碼。  
  3. Go 後端用授權碼向 Keycloak 交換 JWT (Access Token & ID Token)。  
  4. Go 後端驗證 JWT，並為使用者建立一個伺服器端 Session，完成登入。

## **3. UI/UX 結構與功能規格**

### **3.1 核心佈局與通用元件**

* **頁首 (Header):** 固定於頁面頂部，顯示頁面標題、通知鈴鐺、使用者選單及語系切換器。  
* **側邊欄 (Sidebar):** 固定於左側，全螢幕高度，作為主導覽，當前頁面需有高亮樣式。  
* **資料表格 (Data Tables):** 支援搜尋、分頁，並使用狀態指示燈與標籤提升資訊易讀性。表格的搜尋功能在數據量較小的情況下，可由前端實現即時篩選；當數據量較大時，應由後端提供 API 進行模糊查詢，以確保性能。
* **彈出視窗 (Modal):** 用於新增/編輯的表單視窗，以及用於危險操作的確認對話框。

### **3.2 使用者情境與特定頁面規格**

#### **3.2.0 總覽儀表板 (Dashboard)**
* **目標:** 作為系統首頁，提供一個高層次的視圖，讓使用者能快速掌握系統的整體健康狀況與關鍵指標。
* **頁面功能:**
  * **狀態摘要卡片:** 以醒目方式呈現「新告警」、「處理中」、「今日已解決」的數量，並附帶與前一日比較的趨勢箭頭。
  * **關鍵績效指標 (KPI):** 以卡片形式展示「資源妥善率」、「總資源數」等核心指標。
  * **圖表區:** 至少包含以下圖表，以視覺化方式呈現整體健康度：
    * **資源群組狀態總覽:** 以堆疊長條圖顯示各資源群組的正常、警告、異常資源數量。
    * **資源狀態分佈:** 以圓餅圖顯示所有資源的整體狀態分佈。

#### 3.2.1 資源管理 (Resource Management)

* **目標:** 提供對所有監控資源的集中管理與批次操作能力。
* **批次操作功能:**  
  * **表格增強:** 資料表格的每一行前方提供一個 **複選框 (Checkbox)**，表頭處提供「全選/取消全選」功能。  
  * **動態操作欄:** 當使用者勾選任一資源後，表格頂部會動態出現一個「批次操作欄」，顯示已選取的項目數量，並提供以下按鈕：
    * **批次刪除:** 點擊後彈出確認視窗，顯示將要刪除的資源數量。
    * **批次加入群組:** 點擊後彈出視窗，讓使用者選擇要將這些資源加入哪一個或多個「資源群組」。
    * **批次移出群組:** 類似「加入」，但用於移除。
* **網段掃描與探索:**
  * 除了手動新增，系統還提供「掃描網段」功能，允許使用者輸入 CIDR 格式的網段（如 192.168.1.0/24）進行探索。
  * 後端將執行非同步掃描任務，並在完成後將發現的資源列表返回給前端，使用者可勾選需要匯入的資源，實現批次新增。

#### **3.2.2 組織與權限 (Personnel Management)**

* **目標:** 將此頁面重新定位為純粹的「組織與權限」管理功能，移除所有個人化設定。
* **頁面功能:**
  * **權限管理:** 在「新增/編輯人員」的彈出視窗中，管理者僅能設定與組織權限相關的欄位：
    * 姓名 (Name)
    * 角色 (Role)
    * 團隊歸屬 (Team Membership)
  * **職責分離:** 所有個人化的聯絡方式與通知偏好，皆已移至「個人資料」頁面，由使用者自行管理。彈出視窗的介面會明確提示管理者此點，引導其至正確頁面。

#### **3.2.3 團隊管理 (Team Management)**

* **目標:** 讓管理者能定義團隊，並設定當團隊需要被通知時，應該由誰來接收訊息。
* **頁面功能:**
  * **訂閱者管理:** 在「新增/編輯團隊」的彈出視窗中，核心功能是管理該團隊的「通知訂閱者 (Subscribers)」。
  * **統一選擇器:** 提供一個統一的搜尋框，讓管理者可以從「所有人員」和「所有通知管道」中，選擇多個項目作為此團隊的訂閱者。這實現了將告警同時發送給特定人員和特定管道 (如 Slack) 的靈活性。

#### **3.2.4 告警規則 (Alert Rules)**

* **目標:** 讓管理者能定義觸發告警的條件、客製化告警訊息，並可選擇性地綁定自動化修復動作。
* **功能規格:**
  * **摺疊式介面 (Accordion Interface):** 「新增/編輯告警規則」的彈出視窗採用摺疊式 (Accordion) 介面設計，將「基本設定」、「自動化響應」與「通知內容自定義」分門別類，提升資訊組織性與易用性。介面標題具備 Hover 效果與旋轉圖示，提供清晰的互動提示。
  * **自動化響應整合:**
    * 在「新增/編輯告警規則」的彈出視窗中，增加一個 **「自動化響應」** 的選填區塊。
    * 此區塊包含：
        * 一個下拉選單，可從「腳本庫」中選擇一個預先定義好的腳本。
        * 當選擇腳本後，會動態顯示一組輸入框，用於將告警事件的標籤 (Labels) 映射為腳本的參數（例如：將告警中的 instance IP 位址，傳遞給腳本的 -H 參數）。
  * **通知內容自定義 (選填):**
    * 在表單下方，新增一個「通知內容自定義」區塊。
    * 提供 `自訂標題` (Custom Title) 與 `自訂內容` (Custom Content) 兩個欄位。
    * 這兩個欄位需支援變數模板功能，允許使用者插入如 `{{ .ResourceName }}`、`{{ .MetricValue }}` 等變數。若留空，則使用系統預設的通知範本。

#### **3.2.5 自動化 (Automation)**

* **目標:** 建立一個事件驅動的自動化引擎，讓系統在偵測到特定告警時，能自動執行預設的腳本，實現秒級的故障響應。  
* **頁面結構:** 此頁面包含兩個子頁籤：  
  * **腳本庫:** 提供介面讓管理者可以上傳、編輯、刪除自動化腳本（如 Shell Script, Ansible Playbook），並定義腳本需要的輸入參數。  
  * **執行日誌:** 顯示所有自動化腳本的歷史執行紀錄，包含觸發事件、執行時間、狀態與結果，方便追蹤與除錯。

#### **3.2.6 容量規劃 (Capacity Planning)**

* **目標:** 從被動的告警響應，轉向主動的資源規劃。透過分析歷史數據，預測未來資源的消耗趨勢，提前發現潛在的容量瓶頸。  
* **頁面功能:**  
  * **輸入:** 頁面頂部提供下拉選單，讓使用者選擇一個「資源群組」與一個關鍵效能指標（如 平均 CPU 使用率、總磁碟空間使用率）。
  * **輸出:** 選擇完畢並執行分析後，頁面會顯示以下結果：  
    * **關鍵預測指標:** 以卡片形式呈現，例如：「預計將在 **45 天後** 達到 80% 警戒線」、「平均每月增長率： **5.2%**」。  
    * **趨勢圖:** 一張由 Chart.js 繪製的圖表，同時包含過去的歷史數據趨勢線與基於演算法預測的未來趨勢線。

#### **3.2.7 告警紀錄 (Incident History)**

* **目標:** 提供一個集中、可搜尋的介面，用以查看所有歷史與當前的告警事件，並進行生命週期管理。
* **頁面功能:**
  * **進階篩選:** 提供基於時間範圍、告警等級 (高/中/低) 與處理狀態 (新、處理中、已解決) 的篩選功能。
  * **AI 輔助報告:** 允許使用者勾選多筆關聯事件，點擊「生成事件報告」按鈕，由 Gemini AI 自動產出結構化的事件分析報告。
  * **事件詳情:** 點擊單筆紀錄可開啟彈出視窗，查看詳細資訊、新增處理註記、指派處理人員，並執行 Ack (確認) 或 Resolve (解決) 等操作。

#### **3.2.8 通知管道 (Notification Channels)**

* **目標:** 擴充通知管道的功能，使其支援多種主流服務，並提供對應的動態設定欄位。
* **頁面功能:**
  * **擴充管道類型:** 在「新增/編輯通知管道」的彈出視窗中，將「管道類型」下拉選單擴充，需包含 `Email`, `Webhook (通用)`, `Slack`, `LINE Notify`, `SMS`。
  * **動態表單:** 根據使用者選擇的「管道類型」，動態變化下方的設定欄位。各類型對應的欄位如下：
    * **`Email`:**
        * `收件人 (To)`: (文字輸入框)
        * `副本 (CC)`: (文字輸入框)
        * `密件副本 (BCC)`: (文字輸入框)
    * **`Webhook (通用)`:**
        * `Webhook URL`: (文字輸入框)
        * `HTTP 方法 (Method)`: (下拉選單: POST, PUT)
    * **`Slack`:**
        * `Incoming Webhook URL`: (文字輸入框)
        * `提及對象 (Mention)`: (文字輸入框)
    * **`LINE Notify`:**
        * `存取權杖 (Access Token)`: (文字輸入框)
    * **`SMS`:**
        * `收件人手機號碼`: (文字輸入框)

#### **3.2.9 個人資料與系統設定 (Profile & Settings)**

* **目標:** 提供使用者個人化設定與管理員系統級設定的統一入口，並導入更安全的通知設定流程。
* **頁面結構:** 此功能區分為兩個主要頁面：
    * **個人資料 (Profile):** 頁面經過重構，採用 **頁籤式佈局 (Tabbed Layout)**，將相關設定清晰地劃分為三個區塊：
        1.  **`個人資訊`:** 包含姓名、角色、所屬團隊等基本資料。
        2.  **`密碼安全`:** 提供標準的密碼變更功能。
        3.  **`通知設定`:**
            *   **聯絡方式:** 採用與其他表單一致的 **雙欄式佈局**，導入獨立的「儲存與驗證」流程，確保使用者填寫的資訊是有效且可送達的。每一個聯絡管道（Email, LINE, SMS）都擁有獨立的狀態指示器（已驗證 / 未驗證）與操作按鈕（儲存、傳送驗證、測試）。系統在發送告警時，只會將通知發送到狀態為「已驗證」的聯絡方式。
            *   **通知偏好:** 使用者可自訂希望接收哪種嚴重等級 (高/中/低) 的告警通知。
    * **系統設定 (Settings) (僅限管理員):** 頁面採用 **頁籤式佈局 (Tabbed Layout)**，將相關設定清晰地劃分為兩個區塊：
        1.  **`整合設定`:** 包含與外部系統的串接參數，例如 Grafana 的基礎 URL。
        2.  **`通知設定`:** 包含系統發送通知所使用的後端服務設定，例如：
            *   郵件伺服器 (SMTP) 設定
            *   SMS 閘道設定

## **4. 整合流程與資料流**

### **4.1 端到端告警資料流 (含自動化)**

1. **管理與定義:** 管理者在 UI 上建立告警規則，並可選擇關聯一個「自動化腳本」。  
2. **規則同步:** Go 後端將規則同步到 Grafana Alerting。  
3. **數據採集與儲存:** vmagent + snmp_exporter 採集數據，寫入 VictoriaMetrics。  
4. **告警評估與觸發:** Grafana 評估數據，觸發告警，並透過 Webhook 將事件發送到 Go 後端。  
5. **自動化判斷與執行:** Go 後端收到 Webhook，判斷此告警是否關聯了自動化腳本。  
   * **若有關聯:** 將一個包含「腳本 ID」和「參數」的任務發送到 **工作流引擎**。引擎執行腳本，並將結果寫入 **執行日誌**。同時，向維運人員發送的通知會註明「已嘗試自動修復」。  
   * **若無關聯:** 僅發送標準通知。  
6. **閉環完成:** 維運人員在平台內進行 Ack、指派、解決等操作，所有紀錄存回 PostgreSQL。

### **4.2 UI 資料請求流 (HTMX)**

1. **使用者互動:** 使用者點擊一個帶有 hx-get 或 hx-post 屬性的元素。  
2. **HTMX 請求:** HTMX 發送一個攜帶 Session Cookie 的 AJAX 請求到 Go 後端。  
3. **後端處理:** Go 後端的中介軟體驗證 Session，並執行業務邏輯。  
4. **模板渲染:** 處理函式將數據傳遞給一個 **只包含需要更新的 HTML 片段** 的模板進行渲染。  
5. **前端更新:** HTMX 接收到 HTML 片段後，將其無縫地置入當前頁面的指定位置，完成 UI 的局部更新。

## **5. 審查結論與未來展望**

### **5.1 邏輯完整性評估**

當前設計已形成一個 **完整且邏輯嚴謹的閉環**。從系統初始化設定、多角色權限管理，到日常的事件處理、批次管理、自動化響應與容量規劃，核心的操作流程 **無明顯斷層或瑕疵**。

### **5.2 未來展望**

* **【擴展】資產管理與 CMDB 整合：** 將「資源管理」擴展為一個輕量級的資產管理系統，記錄更多資源資訊（如：型號、序號、保固狀態）。
* **【擴展】On-Call 排班與升級策略：** 新增「排班管理」功能，並在告警規則中設定更進階的通知升級策略（例如：若告警在 15 分鐘內未被確認，則自動通知主管）。  
* **【擴展】根因分析** (RCA) **知識庫：** 在「事件詳情」中，增加一個「寫入知識庫」的按鈕，允許維運人員將處理過程與解決